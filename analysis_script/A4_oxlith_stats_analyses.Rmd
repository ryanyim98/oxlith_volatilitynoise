---
title: "oxlith_manuscript"
author: "Ryan Yan"
date: "2023-03-15"
output: html_document
---

```{r include = FALSE, warning=F}
remove(list=ls())
source(here::here("load_library.R"))

theme_set(theme_classic()+
          theme(text = element_text(family = "Helvetica", size = 10)))
orangeNavyPalette = c("orange","steelblue4")
```

```{r message=FALSE}
df_hlm_movement <- read.csv("../../data/movement_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_movement)[6:13] <- paste0("movement_",names(df_hlm_movement)[6:13])
df_hlm_time <- read.csv("../../data/time_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_time)[6:13] <- paste0("time_",names(df_hlm_time)[6:13])
df_hlm_mood <- read.csv("../../data/mood_data_HLM_-14toEnd_allparticipants.csv")

df_hlm <- Reduce(merge, list(df_hlm_movement,df_hlm_time,df_hlm_mood))

df_demo <- read.csv("../../data/demo_info.csv")%>%
  mutate(group_assignment = if_else(Allocation == "B","Lithium", "Control"))
  # filter(ID %in% unique(df_hlm$ID))

participant_num <- length(unique(df_hlm$ID))

df_hlm$group_assignment[df_hlm$Allocation == "A"] <- "control"
df_hlm$group_assignment[df_hlm$Allocation == "B"] <- "lithium"

# mood parameters from 0~4 to 1~5
df_hlm$pos_mean <- df_hlm$pos_mean+5
df_hlm$neg_mean <- df_hlm$neg_mean+5

# mood parameters need log transformation
df_hlm$posLog <- log(df_hlm$pos_mean+1)
df_hlm$negLog <- log(df_hlm$neg_mean+1)

#compute relative amplitude
df_hlm <- df_hlm%>%
  rowwise()%>%
  mutate(rel_amplitude  = (movement_M10_mean - movement_L5_mean)/(movement_M10_mean + movement_L5_mean))

#add season into df
df_hlm <- merge(df_hlm,df_demo[,c("ID","Season","Diagnosis")], by = "ID")

date_info <- read.csv("../../data/movement_data.csv") %>% 
  mutate(Datemdy = as.Date(Date, format = "%m/%d/%y")) %>% 
  select(ID,Day,Datemdy) %>% 
  rename(day = Day)

df_hlm <- left_join(df_hlm,date_info) %>% 
  relocate(Datemdy,.after = day)
```

# integrate seasons and day-of-week effect here
```{r}
df_hlm<-df_hlm %>% 
  mutate(Datem = months(Datemdy),
         Dated = days(Datemdy),
         Datemd = paste0(Datem,Dated),
         Datey = years(Datemdy)) %>% 
  mutate(Dateseason = ifelse(Datemd %in% c(paste0("March",20:31),
                                           paste0("April",1:31),
                                           paste0("May",1:31),
                                           paste0("June",1:20)),"Spring",
                             ifelse(Datemd %in% c(paste0("June",21:31),
                                           paste0("July",1:31),
                                           paste0("August",1:31),
                                           paste0("September",1:21)),"Summer",
                                    ifelse(Datemd %in% c(paste0("September",22:31),
                                           paste0("October",1:31),
                                           paste0("November",1:31),
                                           paste0("December",1:20)),"Autumn",
                                           
                                           ifelse(Datemd %in% c(paste0("December",21:31),
                                             paste0("January",1:31),
                                             paste0("February",1:31),
                                             paste0("March",1:19)),"Winter",NA)))))
  
df_hlm$day_of_week <- weekdays(df_hlm$Datemdy)

df_hlm <- df_hlm %>% 
  mutate(weekday_weekend = ifelse(day_of_week %in% c("Saturday","Sunday"),"weekend",
                                  ifelse(day_of_week %in% c("Monday","Tuesday","Wednesday","Thursday","Friday"),"weekday",NA)))
 #In the northern hemisphere spring begins on the spring equinox (around March 20), summer begins on the summer solstice (around June 21), autumn begins on the autumn equinox (around September 22) and winter on the winter solstice (around December 21).
```

# demographic descriptive stats
```{r}
#reorganize ethnicity
df_demo <- df_demo%>%
  mutate(Ethnicity = if_else(Ethnicity == "", "not reported", if_else(Ethnicity == "other brazilian" | Ethnicity == "Other croatian british","other",Ethnicity)))

df_control <- df_demo%>%filter(group_assignment == "Control")
df_lithium <- df_demo%>%filter(group_assignment == "Lithium")

table(df_demo[,c("Gender","group_assignment")])
chisq.test(table(df_demo[,c("Gender","group_assignment")]))

#ethnicity
table(df_demo[,c("Ethnicity","group_assignment")])
chisq.test(table(df_demo[,c("Ethnicity","group_assignment")]))

chisq.test(table(df_demo[,c("Season","group_assignment")]))

#age
df_demo%>%
  group_by(group_assignment)%>%
  summarise(mean_Age = round(mean(Age),2),
            sd_Age = round(sd(Age),2))
t.test(df_control$Age,df_lithium$Age)

#BMI
df_demo%>%
  group_by(group_assignment)%>%
  summarise(mean_BMI = round(mean(BMI),2),
            sd_BMI = round(sd(BMI),2))
t.test(df_control$BMI,df_lithium$BMI)

#mood
df_mood <- df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  group_by(ID,group_assignment)%>%
  summarise(pos_mean = round(mean(pos_mean,na.rm = TRUE),2),
            neg_mean = round(mean(neg_mean,na.rm = TRUE),2))

df_mood%>%
  group_by(group_assignment)%>%
  summarise(mean_pos = round(mean(pos_mean),2),
            sd_po = round(sd(pos_mean),2),
            mean_neg = round(mean(neg_mean),2),
            sd_neg = round(sd(neg_mean),2))
t.test(df_mood$pos_mean[df_mood$group_assignment == "lithium"],df_mood$pos_mean[df_mood$group_assignment == "control"])
t.test(df_mood$neg_mean[df_mood$group_assignment == "lithium"],df_mood$neg_mean[df_mood$group_assignment == "control"])

#recording days
df_demo%>%
  group_by(group_assignment)%>%
  summarise(median_total.recording.days = median(total.recording.days, na.rm = TRUE))
table(df_demo[,c("total.recording.days","group_assignment")])
t.test(df_lithium$total.recording.days,df_control$total.recording.days)

#missing days
df_demo%>%
  group_by(group_assignment)%>%
  summarise(median_Missing.days = median(Missing.days, na.rm = TRUE))
table(df_demo[,c("Missing.days","group_assignment")])
t.test(df_lithium$Missing.days,df_control$Missing.days)

#BP subtype
table(df_demo[,c("Diagnosis","group_assignment")])
chisq.test(table(df_demo[,c("Diagnosis","group_assignment")]))

#season
table(df_demo[,c("Season","group_assignment")])
chisq.test(table(df_demo[,c("Season","group_assignment")]))
```

## plot data availability
```{r fig.width= 6, fig.height=5, out.width="100%"}
group_N <- count(unique(df_hlm%>%
  select(ID,group_assignment)),group_assignment)

# data availability by week (rolling mean)
ymax = max(group_N$n)+4
p1 <- ggplot(df_hlm%>%
  filter(!is.na(movement_M10_mean))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "bottom",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p2 <- ggplot(df_hlm%>%
  filter(!is.na(pos_mean))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p3 <- ggplot( df_hlm%>%
  filter(!is.na(movement_M10_vmu))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p4 <- ggplot(df_hlm%>%
  filter(!is.na(pos_vmu))%>%
  group_by(group_assignment)%>%
  count(day), aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax -4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax -4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```

```{r}
group_N <- count(unique(df_hlm%>%
  select(ID,group_assignment)),group_assignment)

# data availability by week (rolling mean)
ymax = max(group_N$n)+4
p1a <- ggplot(df_hlm%>%
  filter(!is.na(movement_M10_mean))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "bottom",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p1b <- ggplot(df_hlm%>%
  filter(!is.na(pos_mean))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p1c <- ggplot( df_hlm%>%
  filter(!is.na(movement_M10_vmu))%>%
  group_by(group_assignment)%>%
  count(day),
  aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p1d <- ggplot(df_hlm%>%
  filter(!is.na(pos_vmu))%>%
  group_by(group_assignment)%>%
  count(day), aes(x = day, y = n, color = group_assignment))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax -6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax -6, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```

```{r  fig.width= 8, fig.height=6, out.width="100%",fig.cap="Data availability; grey arrows represent the period of time considered by this study."}
(p1a+p1b)/(p1c+p1d)+ 
  plot_annotation(tag_levels = 'a')

  ggsave("../figs/S1_data_availability.png",width = 8 ,height=6,dpi = 300)
```

## only look at -2 to 4 weeks due to data availability constraints

```{r}
df_hlm <- df_hlm%>%filter(day >= -14 & day <= 28)

df_hlm$phase[df_hlm$day < 1] <- "pre"
df_hlm$phase[df_hlm$day >= 1 & df_hlm$day <= 7] <- "post1"
df_hlm$phase[df_hlm$day >= 8 & df_hlm$day <= 14] <- "post2"
df_hlm$phase[df_hlm$day >= 15 & df_hlm$day <= 21] <- "post3"
df_hlm$phase[df_hlm$day >= 22 & df_hlm$day <= 28] <- "post4"

df_hlm$phase <- factor(df_hlm$phase, levels = c("pre","post1","post2","post3","post4")) #,"post5","post6"

df_hlm <- df_hlm%>%
  relocate(phase, .after= day)
```

# descriptive stats of estimated parameters

## density plot of movement parameters
```{r}
p1d <- ggdensity(df_hlm$movement_M10_mean)+labs(title = "M10 mean",x="")+
  scale_x_continuous(breaks = seq(25,200,by = 75))
p2d <- ggdensity(df_hlm$movement_M10_s)+labs(title = "M10 noise",x="")
p3d <- ggdensity(df_hlm$movement_M10_vmu)+labs(title = "M10 volatility",x="")
p4d <- ggdensity(df_hlm$movement_M10_mu)+labs(title = "M10 mu",x="")
p5d <- ggdensity(df_hlm$movement_L5_mean)+labs(title = "L5 mean",x="")
p6d <- ggdensity(df_hlm$movement_L5_s)+labs(title = "L5 noise",x="")
p7d <- ggdensity(df_hlm$movement_L5_vmu)+labs(title = "L5 volatility",x="")
p8d <- ggdensity(df_hlm$movement_L5_mu)+labs(title = "L5 mu",x="")+
  scale_x_continuous(breaks = seq(0.1,0.5,by = 0.1))

(p1d|p2d|p3d|p4d)/(p5d|p6d|p7d|p8d)+
  plot_annotation(title = "distribution of movement parameters")

 ggsave("../../figs/params_distribution_movement.png",width = 8 ,height=5,dpi = 300)
```

## density plot of movement onset time parameters
```{r}
p1d <- ggdensity(df_hlm$time_M10_mean, linetype = "dashed")+labs(title = "M10 time mean",x="")
p2d <- ggdensity(df_hlm$time_M10_s, linetype = "dashed")+labs(title = "M10 time noise",x="")
p3d <- ggdensity(df_hlm$time_M10_vmu, linetype = "dashed")+labs(title = "M10 time volatility",x="")
p4d <- ggdensity(df_hlm$time_M10_mu, linetype = "dashed")+labs(title = "M10 time mu",x="")
p5d <- ggdensity(df_hlm$time_L5_mean, linetype = "dashed")+labs(title = "L5 time mean",x="")
p6d <- ggdensity(df_hlm$time_L5_s, linetype = "dashed")+labs(title = "L5 time noise",x="")
p7d <- ggdensity(df_hlm$time_L5_vmu, linetype = "dashed")+labs(title = "L5 time volatility",x="")
p8d <- ggdensity(df_hlm$time_L5_mu, linetype = "dashed")+labs(title = "L5 time mu",x="")+
  scale_x_continuous(breaks = seq(0,1,by = 0.3))

(p1d|p2d|p3d|p4d)/(p5d|p6d|p7d|p8d)+
  plot_annotation(title = "distribution of onset time parameters")

 ggsave("../figs/params_distribution_onsetTime.png",width = 8 ,height=5,dpi = 300)
```

## density plot of mood
```{r}
p1d <- ggdensity(df_hlm$posLog)+labs(title = "log PA")
p2d <- ggdensity(df_hlm$negLog)+labs(title = "log NA")
p3d <- ggdensity(df_hlm$pos_vmu)+labs(title = "PA vmu")
p4d <- ggdensity(df_hlm$neg_vmu)+labs(title = "NA vmu")

(p1d|p2d)/(p3d|p4d)
```


# correlation among variables

#correlation heatmap
```{r}
find.corr <- function(df,a,b){
  #df is the dataframe
  #a(IV) and b(DV) are the column index to which the model is fitted
  iv <- names(df)[a]
  dv <- names(df)[b]
  my.formula = as.formula(paste0("scale(",iv,") ~ scale(",dv,") + (1 + scale(",dv,") |ID)"))
  my.lme <- summary(lmer(my.formula,df))
  return(c(my.lme$coefficients[2,1],my.lme$coefficients[2,5])) #beta, p
}
```


```{r}
df_hlm_corr2 <- df_hlm%>%
  select(ID,day, group_assignment,movement_M10_mean,
         time_M10_mean,posLog,negLog,
         movement_M10_vmu,
         time_M10_vmu,
         pos_vmu,neg_vmu,
         movement_M10_s,
         time_M10_s,
         pos_s,neg_s)%>%
  rename(M10 = movement_M10_mean,
         timeM10 = time_M10_mean,
         logPA = posLog,
         logNA = negLog,
         timeM10_vmu = time_M10_vmu,
         M10_vmu = movement_M10_vmu,
         PA_vmu = pos_vmu,
         NA_vmu = neg_vmu,
         M10_s = movement_M10_s,
         timeM10_s = time_M10_s,
         PA_s = pos_s,
         NA_s = neg_s)

num.row2 = ncol(df_hlm_corr2)-3

my.corr.mat2 <- matrix(nrow = num.row2, ncol = num.row2)
my.corr.pmat2 <- matrix(nrow = num.row2, ncol = num.row2)

rownames(my.corr.mat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
colnames(my.corr.mat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
rownames(my.corr.pmat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
colnames(my.corr.pmat2) <- names(df_hlm_corr2)[4:(num.row2+3)]

for (i in 1:num.row2){
  my.corr.mat2[i,i] = 1
  my.corr.pmat2[i,i] = 0
}

for (a in 4:(num.row2+3)){
  for (b in 4:(num.row2+3)){
    if (a != b){
      temp_out <- find.corr(df_hlm_corr2,a,b)
      my.corr.mat2[a-3,b-3] = temp_out[1]
      my.corr.pmat2[a-3,b-3] = temp_out[2]
    }
  }
}

ggcorrplot::ggcorrplot(my.corr.mat2,p.mat = my.corr.pmat2,insig = "blank",colors=c("orange", "white", "steelblue4"),lab = TRUE, digits = 1)
round(my.corr.mat2,3)
round(my.corr.pmat2,3)
ggsave("../figs/S2_corr_plot.png",width = 6 ,height=6,dpi = 300)
```

# time course plot with ribbon

## M10
```{r}
df_hlm_tc <- df_hlm %>% 
  group_by(group_assignment, day) %>% 
  summarise(m_movement_M10_mean = mean(movement_M10_mean, na.rm = T),
            m_movement_M10_vmu = mean(movement_M10_vmu, na.rm = T),
            se_movement_M10_mean = sd(movement_M10_mean, na.rm = T)/sqrt(n()),
            se_movement_M10_vmu = sd(movement_M10_vmu, na.rm = T)/sqrt(n()))

df_hlm_tc$m_movement_M10_mean[is.na(df_hlm_tc$se_movement_M10_mean)] <- NA #only one subj here

ptc1 <- ggplot(df_hlm_tc, aes(x = day, y = m_movement_M10_mean, color = group_assignment))+
  geom_line()+
  geom_ribbon(aes(ymin = m_movement_M10_mean-se_movement_M10_mean,
                  ymax = m_movement_M10_mean+se_movement_M10_mean,
                  fill = group_assignment), alpha = 0.2)+
  ylim(0,100)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_fill_manual(values = orangeNavyPalette)+
  labs(y = "M10 value")+
  geom_vline(xintercept = 0)+
  scale_x_continuous(breaks = seq(-14,28,7))

ptc2 <-ggplot(df_hlm_tc, aes(x = day, y = m_movement_M10_vmu, color = group_assignment))+
  geom_line()+
  geom_ribbon(aes(ymin = m_movement_M10_vmu-se_movement_M10_vmu,
                  ymax = m_movement_M10_vmu+se_movement_M10_vmu,
                  fill = group_assignment), alpha = 0.2)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_fill_manual(values = orangeNavyPalette)+
  labs(y = "M10 volatility")+
  geom_vline(xintercept = 0)+
  scale_x_continuous(breaks = seq(-14,28,7))
```

## M10 time
```{r}
df_hlm_tc <- df_hlm %>% 
  group_by(group_assignment, day) %>% 
  summarise(m_time_M10_mean = mean(time_M10_mean, na.rm = T),
            m_time_M10_vmu = mean(time_M10_vmu, na.rm = T),
            se_time_M10_mean = sd(time_M10_mean, na.rm = T)/sqrt(n()),
            se_time_M10_vmu = sd(time_M10_vmu, na.rm = T)/sqrt(n()))

df_hlm_tc$m_time_M10_mean[is.na(df_hlm_tc$se_time_M10_mean)] <- NA #only one subj here

ptc3 <-ggplot(df_hlm_tc, aes(x = day, y = m_time_M10_mean, color = group_assignment))+
  geom_line()+
  geom_ribbon(aes(ymin = m_time_M10_mean-se_time_M10_mean,
                  ymax = m_time_M10_mean+se_time_M10_mean,
                  fill = group_assignment), alpha = 0.2)+
  ylim(6,18)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_fill_manual(values = orangeNavyPalette)+
  labs(y = "M10 time value")+
  geom_vline(xintercept = 0)+
  scale_x_continuous(breaks = seq(-14,28,7))

ptc4<- ggplot(df_hlm_tc, aes(x = day, y = m_time_M10_vmu, color = group_assignment))+
  geom_line()+
  geom_ribbon(aes(ymin = m_time_M10_vmu-se_time_M10_vmu,
                  ymax = m_time_M10_vmu+se_time_M10_vmu,
                  fill = group_assignment), alpha = 0.2)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_fill_manual(values = orangeNavyPalette)+
  labs(y = "M10 time volatility")+
  geom_vline(xintercept = 0)+
  scale_x_continuous(breaks = seq(-14,28,7))
```

```{r}
ptc1 + ptc2 + ptc3 + ptc4 + plot_layout(nrow = 2)

ggsave("../figs/tc.png",width = 8 ,height=6,dpi = 300)
```

## pre-randomisation check MANOVA
```{r}
# check M10
df1 <- df_hlm%>%
  dplyr::filter(phase == "pre")%>%
  group_by(group_assignment,ID)%>%
  summarise_at(vars(movement_L5_mean:time_M10_mu), ~mean(.x, na.rm = TRUE))

m01 <- manova(cbind(movement_M10_mean,movement_M10_vmu,time_M10_mean,time_M10_vmu) ~ group_assignment, data =df1)
summary.aov(m01)


```

* None of the parameters of interest were different pre-randomization.*


# linear mixed models
## mood
### raw value
```{r}
model_formula_mean <- posLog ~ group_assignment * phase + Age + Gender + Season + (1|ID)

df_hlm_lmer_mood_mean <- df_hlm%>%
  select(ID,group_assignment,phase,day,posLog,negLog,Age,Gender,Season,Dateseason,weekday_weekend)

mod_mood_mean_pos <- lmer(model_formula_mean,data = df_hlm_lmer_mood_mean)
anova(mod_mood_mean_pos)

kable(round(summary(mod_mood_mean_pos)$coefficients,3))

lme.dscore(mod_mood_mean_pos,df_hlm_lmer_mood_mean,type = "lme4")%>%
  as.data.frame()%>%
  kable()

# some additional analysis
summary(lmer(posLog ~ group_assignment * phase + Age + Gender + Season + negLog + (1|ID),data = df_hlm_lmer_mood_mean))
summary(lmer(negLog ~ group_assignment * phase + Age + Gender + Season + (1|ID),data = df_hlm_lmer_mood_mean))

summary(lmer(posLog ~ group_assignment * phase + Age + Gender + Season + Dateseason + weekday_weekend + (1|ID),data = df_hlm_lmer_mood_mean))
```

```{r}
ee1 <- as.data.frame(Effect(c("phase", "group_assignment"),mod_mood_mean_pos))

stat.test <- as.data.frame(round(summary(mod_mood_mean_pos)$coefficients,3))[12:15,]%>%
  rename(p_val = `Pr(>|t|)`)

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$group_assignment == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = ee1$upper[1])%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p8 <- ggplot(ee1, aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "",y="positive mood level")+ 
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

ggplot(ee1, aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = fit-se,ymax=fit+se),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "",y="positive mood level")+ 
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p8
ggsave("../figs/hlm_mood_val.png",width = 4 ,height=3,dpi = 300)
```


### variability
```{r include=TRUE}
model_formula <- val ~ group_assignment * var_type * phase + Age + Gender + Season + (var_type|ID)

df_hlm_lmer_mood_variability <- df_hlm%>%
  select(ID,group_assignment,day,phase,pos_vmu,pos_s,neg_s,Age,Gender,posLog,Season,Dateseason,weekday_weekend)%>%
  pivot_longer(c(pos_vmu,pos_s),names_pattern =  "(.*)_(.*)",names_to = c("mood_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_mood_variability$var_type <- factor(df_hlm_lmer_mood_variability$var_type)

df_hlm_lmer_mood_variability$var_type <- relevel(df_hlm_lmer_mood_variability$var_type, ref = "volatility")

mod_pos_vmu <- lmer(model_formula,data = df_hlm_lmer_mood_variability)
kable(round(summary(mod_pos_vmu)$coefficients,3))

#additional analysis
summary(lmer(val ~ group_assignment * phase + Age + Gender + Season + Dateseason + weekday_weekend + (1+var_type|ID),data = df_hlm_lmer_mood_variability))
```


```{r}
ee2 <- as.data.frame(Effect(c("phase", "group_assignment","var_type"),mod_pos_vmu))%>%
  filter(var_type == "volatility")

stat.test_pos_vmu <- as.data.frame(round(summary(mod_pos_vmu)$coefficients,3))[14:17,]

stat.test <- stat.test_pos_vmu%>%rename(p_val = 'Pr(>|t|)')
stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$group_assignment == "lithium",]%>%
  rename(group1 = phase), by = c("group1"))%>%
  mutate(y.position = ee2$upper[1])%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))


#plot volatility first
p9 <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "",y="positive mood volatility")+
  scale_y_continuous(limits = c(-5.4,-3),breaks = seq(-5.4,-3, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p9
ggsave("../figs/mood_variability.png",width = 4 ,height=3,dpi = 300)
```

## movement
### relative amplitude
```{r}
model_formula_amp <- rel_amplitude ~ group_assignment * phase + posLog + pos_vmu + Age + Gender + Season + (1|ID)
mod_relative_amplitude <- lmer(model_formula_amp,data = df_hlm)
kable(round(summary(mod_relative_amplitude)$coefficients,3))

plot_model(mod_relative_amplitude, type = "pred",terms = c("phase", "group_assignment"))

#additional analysis
summary(lmer(rel_amplitude ~ group_assignment * phase +group_assignment * phase + posLog + pos_vmu + Age + Gender + Season +
               Dateseason + weekday_weekend + (1|ID),data = df_hlm))
```

### raw value
```{r}
model_formula_mean <- val ~ group_assignment * movement_type * phase + posLog + pos_vmu  + Age + Gender + Season +  (movement_type|ID)

df_hlm_lmer_movement_mean <- df_hlm%>%
  select(ID,group_assignment,phase,day,movement_L5_mean,movement_M10_mean,Age,Gender,posLog, negLog, pos_vmu,neg_vmu,Season,
         Dateseason,weekday_weekend)%>%
  pivot_longer(c(movement_L5_mean,movement_M10_mean),names_pattern =  "movement_(.*)_mean",names_to = c("movement_type"),values_to = "val")

df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")

mod_movement_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
anova(mod_movement_mean_M10)
summary(mod_movement_mean_M10)
kable(round(summary(mod_movement_mean_M10)$coefficients,3))
lme.dscore(mod_movement_mean_M10,df_hlm_lmer_movement_mean,type = "lme4")
#calculate percent of change
summary(mod_movement_mean_M10)$coefficients[16:19,1]/(summary(mod_movement_mean_M10)$coefficients[1,1])
                                                           
df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "L5")

mod_movement_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
kable(round(summary(mod_movement_mean_L5)$coefficients,3))
lme.dscore(mod_movement_mean_L5,df_hlm_lmer_movement_mean,type = "lme4")

plot_model(mod_movement_mean_M10, type = "pred", terms = c("phase", "group_assignment","movement_type"))+
  scale_color_manual(values=orangeNavyPalette)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.5),
         panel.grid.minor.y = element_blank())+
  labs(title = "predicted value of movement level",y="movement level")+
  scale_y_continuous(breaks = seq(-10, 70, by = 10))

df_hlm_lmer_movement_mean$group_assignment <- factor(df_hlm_lmer_movement_mean$group_assignment, levels = c("lithium","control"))
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))

df_hlm_lmer_movement_mean$group_assignment <- relevel(df_hlm_lmer_movement_mean$group_assignment, ref = "control")


# additional analysis
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")
df_hlm_lmer_movement_mean$group_assignment <- relevel(df_hlm_lmer_movement_mean$group_assignment, ref = "control")
summary(lmer(val ~ group_assignment * movement_type * phase + posLog + pos_vmu  + Age + Gender + Season + negLog + neg_vmu + (movement_type|ID),df_hlm_lmer_movement_mean))

summary(lmer(val ~ group_assignment * movement_type * phase + posLog + pos_vmu  + Age + Gender + Season + Dateseason + weekday_weekend + (movement_type|ID),df_hlm_lmer_movement_mean))
```

relevel to different weeks to show group contrast:

```{r}
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")
df_hlm_lmer_movement_mean$phase <- relevel(df_hlm_lmer_movement_mean$phase, ref = "post1")
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))

df_hlm_lmer_movement_mean$phase <- relevel(df_hlm_lmer_movement_mean$phase, ref = "post2")
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))

df_hlm_lmer_movement_mean$phase <- relevel(df_hlm_lmer_movement_mean$phase, ref = "post3")
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))


df_hlm_lmer_movement_mean$phase <- relevel(df_hlm_lmer_movement_mean$phase, ref = "post4")
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))

df_hlm_lmer_movement_mean$phase <- factor(df_hlm_lmer_movement_mean$phase,
                                          levels = c("pre","post1","post2","post3","post4"))

plot_model(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean),
           type = "pred",terms = c("phase","group_assignment"))
```


```{r}
# Plot Model using another method
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")
ee1 <- as.data.frame(Effect(c("phase", "group_assignment","movement_type"),mod_movement_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_movement_mean_M10)$coefficients,3))[16:19,]
stat.test_L5 <- as.data.frame(round(summary(mod_movement_mean_L5)$coefficients,3))[16:19,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"movement_type"] <- "L5" 
stat.test[5:8,"movement_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$group_assignment == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(movement_type == "L5",ee1$upper[11],if_else(movement_type == "M10", ee1$upper[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4a <- ggplot(ee1, aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "activity level",y="activity level")+ 
  scale_y_continuous(limits = c(-10,80),breaks = seq(-10, 80, by = 10))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -2)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a
ggsave("../figs/fig2_hlm_movement_val.png",width = 6 ,height=4,dpi = 300)

p4a_M10 <- ggplot(ee1%>%filter(movement_type == "M10"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "daytime activity level",y="daytime activity level (a.u.)", x ="",color = "")+ 
  scale_y_continuous(limits = c(40,85),breaks = seq(40, 85, by = 10))+
  stat_pvalue_manual(stat.test%>%filter(movement_type == "M10"), label = "p_sig",vjust = -4)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a_M10
```


### variability
```{r include=TRUE}
model_formula <- val ~ group_assignment * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + Season + (var_type * movement_type| ID)

df_hlm_lmer_movement_variability <- df_hlm%>%
  select(ID,Season,group_assignment,day,phase,movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu,Age,Gender,posLog, negLog, pos_vmu,neg_vmu,
         Dateseason,weekday_weekend)%>%
  pivot_longer(c(movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu),names_pattern =  "movement_(.*)_(.*)",names_to = c("movement_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_movement_variability$var_type <- factor(df_hlm_lmer_movement_variability$var_type)
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "noise")
df_hlm_lmer_movement_variability$movement_type <- factor(df_hlm_lmer_movement_variability$movement_type)
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

mod_movement_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
summary(mod_movement_var_s_M10)
round(summary(mod_movement_var_s_M10)$coefficients,3)
lme.dscore(mod_movement_var_s_M10,df_hlm_lmer_movement_variability,type = "lme4")

df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

summary(lmer( val ~ group_assignment * var_type * movement_type * phase + posLog + pos_vmu + negLog + neg_vmu + Age + Gender + Season + (var_type * movement_type| ID),df_hlm_lmer_movement_variability))

#same model, different reference level
mod_movement_var_vmu_M10 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)

#calculate percent of change
summary(mod_movement_var_vmu_M10)$coefficients[19:22,1]/(summary(mod_movement_var_vmu_M10)$coefficients[1,1])

kable(round(summary(mod_movement_var_vmu_M10)$coefficients,4))
kable(summary(mod_movement_var_vmu_M10)$coefficients,digits = 3)
lme.dscore(mod_movement_var_vmu_M10,df_hlm_lmer_movement_variability,type = "lme4")

#relevel to show main effect of time in lithium group
df_hlm_lmer_movement_variability$group_assignment <- factor(df_hlm_lmer_movement_variability$group_assignment, levels = c("lithium","control"))
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_movement_variability))$coefficients,3))

df_hlm_lmer_movement_variability$group_assignment <- relevel(df_hlm_lmer_movement_variability$group_assignment, ref = "control")

#same model, different reference level
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "noise")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "L5")

mod_movement_var_s_L5 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_s_L5)$coefficients,3))
lme.dscore(mod_movement_var_s_L5,df_hlm_lmer_movement_variability,type = "lme4")

df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "L5")

mod_movement_var_vmu_L5 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_vmu_L5)$coefficients,3))
lme.dscore(mod_movement_var_vmu_L5,df_hlm_lmer_movement_variability,type = "lme4")

plot_model(mod_movement_var_s_M10, type = "pred", terms = c("phase", "group_assignment","movement_type","var_type"))

# additional analyses
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
summary(lmer(val ~ group_assignment * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + Season + Dateseason + weekday_weekend + (var_type * movement_type| ID),data = df_hlm_lmer_movement_variability))
```

*Conclusion: lithium increased volatility of M10 and L5 by week 4.*
*Conclusion: Lithium increases daytime volatility and decreases nighttime volatility of time*

## relevel to different weeks to show group contrast
```{r}
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
df_hlm_lmer_movement_variability$phase <- relevel(df_hlm_lmer_movement_variability$phase, ref = "post1")
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_movement_variability))$coefficients,3))

df_hlm_lmer_movement_variability$phase <- relevel(df_hlm_lmer_movement_variability$phase, ref = "post2")
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_movement_variability))$coefficients,3))

df_hlm_lmer_movement_variability$phase <- relevel(df_hlm_lmer_movement_variability$phase, ref = "post3")
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_movement_variability))$coefficients,3))

df_hlm_lmer_movement_variability$phase <- relevel(df_hlm_lmer_movement_variability$phase, ref = "post4")
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_movement_variability))$coefficients,3))

df_hlm_lmer_movement_variability$phase <- factor(df_hlm_lmer_movement_variability$phase,
                                          levels = c("pre","post1","post2","post3","post4"))

plot_model(lmer(model_formula,data = df_hlm_lmer_movement_variability),
           type = "pred",terms = c("phase","group_assignment"))
```

```{r}
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
ee2 <- as.data.frame(Effect(c("phase", "group_assignment","movement_type","var_type"),mod_movement_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_movement_var_s_M10)$coefficients,3))[19:22,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_movement_var_s_L5)$coefficients,3))[19:22,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_movement_var_vmu_M10)$coefficients,3))[19:22,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_movement_var_vmu_L5)$coefficients,3))[19:22,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"movement_type"] <- "M10" 
stat.test[c(5:8,13:16),"movement_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$group_assignment == "lithium",]%>%
  rename(group1 = phase), by = c("movement_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility",ee2$upper[1],if_else(var_type == "noise", ee2$upper[21],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p11a <- ggplot(ee2%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="activity noise")+
  scale_y_continuous(limits = c(-2,-1),breaks = seq(-2,-1, by = 0.2))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -3)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))


#plot volatility first
p11b <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="activity volatility")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p11a/p11b

ggsave("../figs/hlm_movement_variability.png",width = 7 ,height=7,dpi = 300)

p11b_M10 <- ggplot(ee2%>%filter(var_type == "volatility", movement_type == "M10"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "daytime activity volatility",y="daytime activity volatility",x="",color = "")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", movement_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```


## time
### raw value
```{r}
model_formula_mean <- val ~ group_assignment * time_type * phase + posLog + pos_vmu + Age + Gender  + Season + (time_type|ID)

df_hlm_lmer_time_mean <- df_hlm%>%
  select(ID,group_assignment,phase,day,time_L5_mean,time_M10_mean,Age,Gender,posLog,negLog, pos_vmu,Season, Dateseason, weekday_weekend)%>%
  pivot_longer(c(time_L5_mean,time_M10_mean),names_pattern =  "time_(.*)_mean",names_to = c("time_type"),values_to = "val")

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")

mod_time_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_M10)$coefficients,3))
lme.dscore(mod_time_mean_M10,df_hlm_lmer_time_mean,type = "lme4")

#calculate percent of change
summary(mod_time_mean_M10)$coefficients[16:19,1]/(summary(mod_time_mean_M10)$coefficients[1,1])

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "L5")

mod_time_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_L5)$coefficients,3))
lme.dscore(mod_time_mean_L5,df_hlm_lmer_time_mean,type = "lme4")

plot_model(mod_time_mean_M10, type = "pred", terms = c("phase", "group_assignment","time_type"))+
  scale_color_manual(values=orangeNavyPalette)+
  theme_bw()+
  labs(title = "predicted value of onset time",y="onset time")


# additional analyses
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")
summary(lmer(val ~ group_assignment * time_type * phase + posLog + pos_vmu + Age + Gender  + Season + Dateseason + weekday_weekend + (time_type|ID),data = df_hlm_lmer_time_mean))
```

```{r}
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")
ee3 <- as.data.frame(Effect(c("phase", "group_assignment","time_type"),mod_time_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_time_mean_M10)$coefficients,3))[16:19,]
stat.test_L5 <- as.data.frame(round(summary(mod_time_mean_L5)$coefficients,3))[16:19,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"time_type"] <- "L5" 
stat.test[5:8,"time_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee3[ee3$phase != "pre" & ee3$group_assignment == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(time_type == "L5",ee3$upper[11],if_else(time_type == "M10", ee3$upper[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4b <- ggplot(ee3, aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "activity onset time",y="activity onset time (hrs)")+ 
  scale_y_continuous(limits = c(10,30),breaks = seq(10,30, by = 2.5))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -2)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b
ggsave("../figs/hlm_time_val.png",width = 6 ,height=4,dpi = 300)

# p4a/p4b
# ggsave("../figs/fig2_vals.png",width = 7 ,height=7,dpi = 300)

p4b_M10 <- ggplot(ee3%>%filter(time_type == "M10"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "daytime activity onset time",y="daytime activity onset time (hrs)",x="")+ 
  scale_y_continuous(limits = c(8,16),breaks = seq(8, 16, by = 2))+
  stat_pvalue_manual(stat.test%>%filter(time_type == "M10"), label = "p_sig",vjust = -3)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b_M10
```

### variability 
```{r include=TRUE}
model_formula <- val ~ group_assignment * var_type * time_type * phase + posLog + pos_vmu + Age + Gender + Season + (var_type * time_type|ID)

df_hlm_lmer_time_variability <- df_hlm%>%
  select(ID,group_assignment,day,phase,time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu,Age,Gender,Season,posLog, negLog, pos_vmu,neg_vmu)%>%
  pivot_longer(c(time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu),names_pattern =  "time_(.*)_(.*)",names_to = c("time_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_time_variability$var_type <- factor(df_hlm_lmer_time_variability$var_type)
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- factor(df_hlm_lmer_time_variability$time_type)
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

mod_time_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_M10)$coefficients,3))
lme.dscore(mod_time_var_s_M10,df_hlm_lmer_time_variability,type = "lme4")

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

#same model, different reference level
mod_time_var_vmu_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
#calculate percent of change
summary(mod_time_var_vmu_M10)$coefficients[19:22,1]/(summary(mod_time_var_vmu_M10)$coefficients[1,1])

kable(round(summary(mod_time_var_vmu_M10)$coefficients,3))
lme.dscore(mod_time_var_vmu_M10,df_hlm_lmer_time_variability,type = "lme4")

#relevel to lithium group to get the main effect of time
df_hlm_lmer_time_variability$group_assignment <- factor(df_hlm_lmer_time_variability$group_assignment, levels = c("lithium","control"))
kable(round(summary(lmer(model_formula,data = df_hlm_lmer_time_variability))$coefficients,3))

df_hlm_lmer_time_variability$group_assignment <- relevel(df_hlm_lmer_time_variability$group_assignment, ref = "control")

# #same model, different reference level
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")

mod_time_var_s_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_L5)$coefficients,3))
lme.dscore(mod_time_var_s_L5,df_hlm_lmer_time_variability,type = "lme4")

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")

df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")
mod_time_var_vmu_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_vmu_L5)$coefficients,3))
lme.dscore(mod_time_var_vmu_L5,df_hlm_lmer_time_variability,type = "lme4")

plot_model(mod_time_var_s_M10, type = "pred", terms = c("phase", "group_assignment","time_type","var_type"))+
  labs(title="predicted value of onset time variability",y="noise")
ggsave("../figs/hlm_time_variability_comparison.png",width = 7 ,height=7,dpi = 300)
```

```{r}
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")
ee4 <- as.data.frame(Effect(c("phase", "group_assignment","time_type","var_type"),mod_time_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_time_var_s_M10)$coefficients,3))[19:22,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_time_var_s_L5)$coefficients,3))[19:22,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_time_var_vmu_M10)$coefficients,3))[19:22,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_time_var_vmu_L5)$coefficients,3))[19:22,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"time_type"] <- "M10" 
stat.test[c(5:8,13:16),"time_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee4[ee4$phase != "pre" & ee4$group_assignment == "lithium",]%>%
  rename(group1 = phase), by = c("time_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility" & time_type == "L5",ee4$upper[11],if_else(var_type == "volatility" & time_type == "M10", ee4$upper[1],if_else(var_type == "noise" & time_type == "L5",ee4$upper[36],if_else(var_type == "noise" & time_type == "M10",ee4$upper[21],0)))))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p12a <- ggplot(ee4%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement noise")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

#plot volatility first
p12b <- ggplot(ee4%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement volatility")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p12a/p12b
ggsave("../figs/hlm_time_variability.png",width = 7 ,height=7,dpi = 300)

p12b_M10 <- ggplot(ee4%>%filter(var_type == "volatility", time_type == "M10"), aes(x = phase, y = fit, color = group_assignment))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=30))+
  labs(title = "daytime onset time volatility",y="daytime onset time volatility",x="")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", time_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```


# is amount of change correlated across domains?
```{r}
df_hlm_change <- df_hlm %>% 
  group_by(ID, group_assignment, phase,Age,Gender,Season) %>% 
  summarise_at(vars(movement_M10_vmu,movement_M10_mean,
                    time_M10_vmu,time_M10_mean,posLog,pos_vmu), ~mean(.x, na.rm = T)) %>% 
  pivot_wider(names_from = phase, values_from = c(movement_M10_vmu,movement_M10_mean,
                                                  time_M10_vmu,time_M10_mean,posLog,pos_vmu)) %>% 
  rowwise() %>% 
  mutate(M10_change = `movement_M10_mean_post4` - `movement_M10_mean_pre`,
         M10_vmu_change = `movement_M10_vmu_post4` - `movement_M10_vmu_pre`,
         timeM10_change = `time_M10_mean_post4` - `time_M10_mean_pre`,
         timeM10_vmu_change = `time_M10_vmu_post4` - `time_M10_vmu_pre`,
         posLog_change = `posLog_post4` - `posLog_pre`,
         pos_vmu_change = `pos_vmu_post4` - `pos_vmu_pre`,)

l1 <- lm(M10_change ~ M10_vmu_change + Age + Gender + Season, df_hlm_change)
summary(l1)
lm.beta::lm.beta(l1)

summary(lm(timeM10_change ~ timeM10_vmu_change + Age + Gender+Season, df_hlm_change))
lm.beta::lm.beta(lm(timeM10_change ~ timeM10_vmu_change + Age + Gender+Season, df_hlm_change))

summary(lm(timeM10_vmu_change ~ M10_vmu_change + Age + Gender + Season, df_hlm_change))
lm.beta::lm.beta(lm(timeM10_vmu_change ~ M10_vmu_change + Age + Gender + Season, df_hlm_change))

summary(lm(timeM10_change ~ M10_change + Age + Gender + Season, df_hlm_change))
lm.beta::lm.beta(lm(timeM10_change ~ M10_change + Age + Gender+Season, df_hlm_change))

pcorr1 <- ggplot(df_hlm_change, aes(y = M10_change, x = M10_vmu_change))+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_smooth(method = "lm", color = "black")+
  geom_point(aes(color = group_assignment))+
  scale_color_manual(values = orangeNavyPalette)+
  annotate("text",y = 16 ,x = -0.5, label = "r = -.356, p = .185\nN=24")+
  labs(x = "change in M10 volatility",
       y = "change in M10 level", color = "")

pcorr2 <-  ggplot(df_hlm_change, aes(y = timeM10_vmu_change, x = M10_vmu_change))+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_smooth(method = "lm", color = "black")+
  geom_point(aes(color = group_assignment))+
  scale_color_manual(values = orangeNavyPalette)+
  annotate("text",x = -0.5,y = 1, label = "r = 0.385, p = .063 \nN=33")+
  labs(y = "change in volatility of M10 onset time",
       x = "change in volatility of M10 level")
```

### heatmap
```{r}
# all subjs
df_hlm_change_corr <- df_hlm_change %>% 
  ungroup() %>% 
  filter(group_assignment == "control") %>% 
  dplyr::select(M10_change:pos_vmu_change) %>% 
  rename(M10 = M10_change,
         M10_volatility = M10_vmu_change,
         timeM10 = timeM10_change,
         timeM10_volatility = timeM10_vmu_change,
         PA = posLog_change,
         PA_volatility = pos_vmu_change)
corr_lm <- cor_mat(df_hlm_change_corr)
corr_lm_pmat <- cor_pmat(df_hlm_change_corr)

df_hlm_change_corr2 <- df_hlm_change %>% 
  filter(group_assignment == "lithium") %>% 
  ungroup() %>% 
  dplyr::select(M10_change:pos_vmu_change) %>% 
  rename(M10 = M10_change,
         M10_volatility = M10_vmu_change,
         timeM10 = timeM10_change,
         timeM10_volatility = timeM10_vmu_change,
         PA = posLog_change,
         PA_volatility = pos_vmu_change)
corr_lm2 <- cor_mat(df_hlm_change_corr2)
corr_lm_pmat2 <- cor_pmat(df_hlm_change_corr2)

ggcorrplot::ggcorrplot(corr_lm,type = "upper",
                       colors=c("orange", "white", "steelblue4"),lab_size = 5,  pch.cex =0,pch.col="white",
                        lab = TRUE, digits = 2,hc.method = "complete")+
  labs(title = "Correlations among amount of change (week4 - baseline)",
       subtitle = "Placebo group only (N = 15)")+
ggcorrplot::ggcorrplot(corr_lm2,type = "upper",
                       colors=c("orange", "white", "steelblue4"),lab_size = 5,pch.cex = 0,pch.col="white",
                        lab = TRUE, digits = 2,hc.method = "complete")+
  labs(title = "Correlations among amount of change (week4 - baseline)",
       subtitle = "Lithium group only (N = 19)")+
plot_layout(nrow = 2)
ggsave("../figs/S12_corr_plot.png",width = 7 ,height=10,dpi = 300)
```


# print manuscript graphs
```{r manuscript figs}
p4a_M10 + p11b_M10+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/movement.png",width = 7 ,height=3,dpi = 300)

p4b_M10 + p12b_M10+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/time.png",width = 7 ,height=3,dpi = 300)

# (p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10)/
# ggplot()+
#   geom_line(aes(x = t_series, y = values_control, color = "low volatility"))+
#   geom_line(aes(x = t_series, y = values_lithium, color = "high volatility")) +
#   labs(color = "Time series", x = "trial (day)", y = "Observed value",
#        title = "Simulated data with high vs. low volatility")+
#   scale_color_manual(values = c("low volatility" = orangeNavyPalette[1],
#                                 "high volatility" = orangeNavyPalette[2]))+
#   plot_annotation(tag_levels = c("a"))

(p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10) / (pcorr1+pcorr2)+
  plot_annotation(tag_levels = "a")
ggsave("../figs/FIG4_movement_n_time.png",width = 9 ,height=9,dpi = 300)
  
(p8 + p9) / (p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10) +
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/movement_n_time_n_pa.png",width = 7 ,height=10,dpi = 300)

p8+theme(legend.position = "left") + p9+theme(legend.position = "none")+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/mood_variability.png",width = 7 ,height=3,dpi = 300)
```


<!-- # correlating change in vmu and mean -->

<!-- ```{r} -->
<!-- df_hlm$phase <- factor(df_hlm$phase, labels = c("run-in","week 1","week 2","week 3","week 4")) -->

<!-- cA1 <- lmer(time_M10_mean ~ group_assignment * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA1) -->

<!-- cA2 <- lmer(pos_mean ~ group_assignment * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA2) -->

<!-- cA3 <- lmer(pos_mean ~ group_assignment * time_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA3) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- cB1 <- lmer(time_M10_vmu ~ group_assignment * movement_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB1) -->
<!-- pC1 <- plot_model(cB1, type = "pred", terms = c("movement_M10_vmu","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity volatility", -->
<!--        y = "activity onset time volatility") -->
<!-- pC1$facet$params$nrow=1 -->

<!-- cB2 <- lmer(pos_vmu ~ group_assignment * movement_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB2) -->
<!-- pC2 <- plot_model(cB2, type = "pred", terms = c("movement_M10_vmu","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity volatility", -->
<!--        y = "PA volatility")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC2$facet$params$nrow=1 -->

<!-- cB3 <- lmer(pos_vmu ~ group_assignment * time_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB3) -->
<!-- pC3 <- plot_model(cB3, type = "pred", terms = c("time_M10_vmu","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time volatility", -->
<!--        y = "PA volatility")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC3$facet$params$nrow=1 -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pC1+pC2+pC3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- cC1 <- lmer(time_M10_mean ~ group_assignment * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC1) -->
<!-- pC1 <- plot_model(cC1, type = "pred", terms = c("movement_M10_mean","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity", -->
<!--        y = "activity onset time") -->
<!-- pC1$facet$params$nrow=1 -->

<!-- cC2 <- lmer(posLog ~ group_assignment * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC2) -->
<!-- pC2 <- plot_model(cC2, type = "pred", terms = c("movement_M10_mean","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity", -->
<!--        y = "PA")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC2$facet$params$nrow=1 -->

<!-- cC3 <- lmer(posLog ~ group_assignment * time_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC3) -->
<!-- pC3 <- plot_model(cC3, type = "pred", terms = c("time_M10_mean","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time", -->
<!--        y = "PA")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC3$facet$params$nrow=1 -->

<!-- pC1+pC2+pC3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope_rawval.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- cD1 <- lmer(time_M10_s ~ group_assignment * movement_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD1) -->
<!-- pD1 <- plot_model(cD1, type = "pred", terms = c("movement_M10_s","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime movement noise", -->
<!--        y = "movement onset time noise") -->
<!-- pD1$facet$params$nrow=1 -->

<!-- cD2 <- lmer(pos_s ~ group_assignment * movement_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD2) -->
<!-- pD2 <- plot_model(cD2, type = "pred", terms = c("movement_M10_s","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime movement noise", -->
<!--        y = "PA noise")+ -->
<!--   theme(legend.position = "none") -->

<!-- pD2$facet$params$nrow=1 -->

<!-- cD3 <- lmer(pos_s ~ group_assignment * time_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD3) -->
<!-- pD3 <- plot_model(cD3, type = "pred", terms = c("time_M10_s","group_assignment","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time noise", -->
<!--        y = "PA noise")+ -->
<!--   theme(legend.position = "none") -->

<!-- pD3$facet$params$nrow=1 -->

<!-- pD1+pD2+pD3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope_noise.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->

<!-- # are changes correlated? -->

<!-- ```{r} -->
<!-- change <- df_hlm%>% -->
<!--   group_by(ID, group_assignment,phase)%>% -->
<!--   summarise_at(vars(movement_L5_mean:negLog),~mean(.x, na.rm = T))%>% -->
<!--   pivot_longer(movement_L5_mean:negLog, names_to = "var", values_to = "val")%>% -->
<!--   pivot_wider(names_from = "phase", values_from = "val")%>% -->
<!--   rowwise()%>% -->
<!--   mutate(post4 = ifelse(!is.na(post4),post4, -->
<!--                          ifelse(!is.na(post3),post3, -->
<!--                                 ifelse(!is.na(post2), -->
<!--                                        post2, -->
<!--                                        ifelse(!is.na(post1), -->
<!--                                               post1,NA)))))%>% -->
<!--   pivot_longer(pre:post4,names_to = "phase", values_to = "val")%>% -->
<!--   pivot_wider(names_from = "var", values_from = "val")%>% -->
<!--   filter(phase %in% c("pre","post4"))%>% -->
<!--   pivot_wider(names_from = phase, values_from = movement_L5_mean:negLog, -->
<!--               names_sep = "_")%>% -->
<!--   mutate(L5_mean_diff = movement_L5_mean_post4 - movement_L5_mean_pre, -->
<!--          L5_noise_diff = movement_L5_s_post4 - movement_L5_s_pre, -->
<!--          L5_volatility_diff = movement_L5_vmu_post4 - movement_M10_vmu_pre, -->
<!--          M10_mean_diff = movement_M10_mean_post4 - movement_M10_mean_pre, -->
<!--          M10_noise_diff = movement_M10_s_post4 - movement_M10_s_pre, -->
<!--          M10_volatility_diff = movement_M10_vmu_post4 - movement_M10_vmu_pre, -->
<!--          time_L5_mean_diff = time_L5_mean_post4 - time_L5_mean_pre, -->
<!--          time_L5_noise_diff = time_L5_s_post4 - time_L5_s_pre, -->
<!--          time_L5_volatility_diff = time_L5_vmu_post4 - time_M10_vmu_pre, -->
<!--          time_M10_mean_diff = time_M10_mean_post4 - time_M10_mean_pre, -->
<!--          time_M10_noise_diff = time_M10_s_post4 - time_M10_s_pre, -->
<!--          time_M10_volatility_diff = time_M10_vmu_post4 - time_M10_vmu_pre, -->
<!--          pos_mean_diff = pos_mean_post4 - pos_mean_pre, -->
<!--          pos_noise_diff = pos_s_post4 - pos_s_pre, -->
<!--          pos_volatility_diff = pos_vmu_post4 - pos_vmu_pre, -->
<!--          neg_mean_diff = neg_mean_post4 - neg_mean_pre, -->
<!--          neg_noise_diff = neg_s_post4 - neg_s_pre, -->
<!--          neg_volatility_diff = neg_vmu_post4 - neg_vmu_pre)%>% -->
<!--   select(ID,group_assignment,L5_mean_diff:neg_volatility_diff) -->
<!-- ``` -->

<!-- ## cross-panel -->
<!-- ```{r} -->
<!-- change_corr_lithium <- change%>% -->
<!--   filter(group_assignment == "lithium")%>% -->
<!--   ungroup()%>% -->
<!--   select(M10_volatility_diff, -->
<!--          M10_mean_diff, -->
<!--          time_M10_mean_diff, -->
<!--          time_M10_volatility_diff, -->
<!--          pos_volatility_diff, -->
<!--          pos_mean_diff) -->

<!-- corr.mat1 <- round(cor(change_corr_lithium, -->
<!--                 use = "complete.obs"),1) -->
<!-- # corr.pmat1 <- as.matrix(cor_pmat(change_corr_lithium)[,2:(ncol(change_corr_lithium)+1)]) -->

<!-- c1 <- ggcorrplot::ggcorrplot(corr.mat1,    -->
<!--                        hc.order = FALSE, type = "lower", -->
<!--    outline.col = "white", -->
<!--    lab = TRUE, -->
<!--    ggtheme = ggplot2::theme_gray, -->
<!--    colors = c("navy", "white", "orange"))+ -->
<!--   labs(title = "Lithium group") -->

<!-- change_corr_control <- change%>% -->
<!--   filter(group_assignment == "control")%>% -->
<!--   ungroup()%>% -->
<!--   select(M10_volatility_diff, -->
<!--          M10_mean_diff, -->
<!--          time_M10_mean_diff, -->
<!--          time_M10_volatility_diff, -->
<!--          pos_volatility_diff, -->
<!--          pos_mean_diff) -->

<!-- corr.mat2 <- round(cor(change_corr_control, -->
<!--                 use = "complete.obs"),1) -->
<!-- # corr.pmat2 <- as.matrix(cor_pmat(change_corr_control)[,2:(ncol(change_corr_control)+1)]) -->

<!-- c2 <- ggcorrplot::ggcorrplot(corr.mat2,    -->
<!--                        hc.order = FALSE, type = "lower", -->
<!--    outline.col = "white", -->
<!--    lab = TRUE, -->
<!--    ggtheme = ggplot2::theme_gray, -->
<!--    colors = c("navy", "white", "orange"))+ -->
<!--   labs(title = "Control group") -->

<!-- # c3 <- ggcorrplot::ggcorrplot(corr.mat2 - corr.mat1,    -->
<!-- #                        hc.order = FALSE, type = "lower", -->
<!-- #    outline.col = "white", -->
<!-- #    lab = TRUE, -->
<!-- #    ggtheme = ggplot2::theme_gray, -->
<!-- #    colors = c("navy", "white", "orange"))+ -->
<!-- #   labs(title = "Control - Lithium") -->
<!-- ``` -->

<!-- ```{r fig.width=10, fig.height=10} -->
<!-- c1+c2 -->
<!-- ``` -->

