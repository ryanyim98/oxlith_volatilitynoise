---
title: "oxlith_manuscript"
author: "Ryan Yan"
date: "2023-03-15"
output: html_document
---

```{r include = FALSE, warning=F}
remove(list=ls())
source(here::here("load_library.R"))

theme_set(theme_classic()+
          theme(text = element_text(family = "Helvetica", size = 10)))
orangeNavyPalette = c("orange","steelblue4")
```

```{r message=FALSE}
df_hlm_movement <- read.csv("../../data/movement_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_movement)[6:13] <- paste0("movement_",names(df_hlm_movement)[6:13])
df_hlm_time <- read.csv("../../data/time_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_time)[6:13] <- paste0("time_",names(df_hlm_time)[6:13])
df_hlm_mood <- read.csv("../../data/mood_data_HLM_-14toEnd_allparticipants.csv")

df_hlm <- Reduce(merge, list(df_hlm_movement,df_hlm_time,df_hlm_mood))

df_demo <- read.csv("../../data/demo_info.csv")%>%
  mutate(Allocation = if_else(Allocation == "B","Lithium", "Control"))
  # filter(ID %in% unique(df_hlm$ID))

participant_num <- length(unique(df_hlm$ID))

df_hlm$Allocation[df_hlm$Allocation == "A"] <- "control"
df_hlm$Allocation[df_hlm$Allocation == "B"] <- "lithium"

# mood parameters from 0~4 to 1~5
df_hlm$pos_mean <- df_hlm$pos_mean+5
df_hlm$neg_mean <- df_hlm$neg_mean+5

# mood parameters need log transformation
df_hlm$posLog <- log(df_hlm$pos_mean+1)
df_hlm$negLog <- log(df_hlm$neg_mean+1)

#compute relative amplitude
df_hlm <- df_hlm%>%
  rowwise()%>%
  mutate(rel_amplitude  = (movement_M10_mean - movement_L5_mean)/(movement_M10_mean + movement_L5_mean))

#add season into df
df_hlm <- merge(df_hlm,df_demo[,c("ID","Season","Diagnosis")], by = "ID")

date_info <- read.csv("../../data/movement_data.csv") %>% 
  mutate(Datemdy = as.Date(Date, format = "%m/%d/%y")) %>% 
  select(ID,Day,Datemdy) %>% 
  rename(day = Day)

df_hlm <- left_join(df_hlm,date_info) %>% 
  relocate(Datemdy,.after = day)
```

# integrate seasons and day-of-week effect here
```{r}
df_hlm<-df_hlm %>% 
  mutate(Datem = months(Datemdy),
         Dated = days(Datemdy),
         Datemd = paste0(Datem,Dated),
         Datey = years(Datemdy)) %>% 
  mutate(Dateseason = ifelse(Datemd %in% c(paste0("March",20:31),
                                           paste0("April",1:31),
                                           paste0("May",1:31),
                                           paste0("June",1:20)),"Spring",
                             ifelse(Datemd %in% c(paste0("June",21:31),
                                           paste0("July",1:31),
                                           paste0("August",1:31),
                                           paste0("September",1:21)),"Summer",
                                    ifelse(Datemd %in% c(paste0("September",22:31),
                                           paste0("October",1:31),
                                           paste0("November",1:31),
                                           paste0("December",1:20)),"Autumn",
                                           
                                           ifelse(Datemd %in% c(paste0("December",21:31),
                                             paste0("January",1:31),
                                             paste0("February",1:31),
                                             paste0("March",1:19)),"Winter",NA)))))
  
df_hlm$day_of_week <- weekdays(df_hlm$Datemdy)

df_hlm <- df_hlm %>% 
  mutate(weekday_weekend = ifelse(day_of_week %in% c("Saturday","Sunday"),"weekend",
                                  ifelse(day_of_week %in% c("Monday","Tuesday","Wednesday","Thursday","Friday"),"weekday",NA)))
 #In the northern hemisphere spring begins on the spring equinox (around March 20), summer begins on the summer solstice (around June 21), autumn begins on the autumn equinox (around September 22) and winter on the winter solstice (around December 21).
```

# data inspection
## data availability
```{r}
participant_num

data_path <- "../../data/"
df_hlm_movement <- read.csv(paste0(data_path,"movement_data_HLM_-14toEnd_allparticipants.csv"))
names(df_hlm_movement)[6:13] <- paste0("movement_",names(df_hlm_movement)[6:13])

df_hlm_time <- read.csv(paste0(data_path,"time_data_HLM_-14toEnd_allparticipants.csv"))
names(df_hlm_time)[6:13] <- paste0("time_",names(df_hlm_time)[6:13])

df_hlm_mood <- read.csv(paste0(data_path,"mood_data_HLM_-14toEnd_allparticipants.csv"))

df_hlm <- Reduce(merge, list(df_hlm_movement,df_hlm_time,df_hlm_mood))

df_demo <- read.csv(paste0(data_path,"/demo_info.csv"))%>%
  mutate(Allocation = if_else(Allocation == "B","Lithium", "Control"))

participant_num <- length(unique(df_hlm$ID))

df_hlm$Allocation[df_hlm$Allocation == "A"] <- "control"
df_hlm$Allocation[df_hlm$Allocation == "B"] <- "lithium"

# mood parameters from 0~4 to 1~5
df_hlm$pos_mean <- df_hlm$pos_mean+5
df_hlm$neg_mean <- df_hlm$neg_mean+5

# mood parameters need log transformation
df_hlm$posLog <- log(df_hlm$pos_mean+1)
df_hlm$negLog <- log(df_hlm$neg_mean+1)

#compute relative amplitude
df_hlm <- df_hlm%>%
  rowwise()%>%
  mutate(rel_amplitude  = (movement_M10_mean - movement_L5_mean)/(movement_M10_mean + movement_L5_mean))

#add season into df
df_hlm <- merge(df_hlm,df_demo[,c("ID","Season","Diagnosis")], by = "ID")
```

# linear mixed models
## mood
### raw value
```{r}
model_formula_mean <- posLog ~ Allocation * phase + Age + Gender + Season + Dateseason + weekday_weekend + (1|ID)

df_hlm_lmer_mood_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,posLog,negLog,Age,Gender,Season,Dateseason,weekday_weekend)

mod_mood_mean_pos <- lmer(model_formula_mean,data = df_hlm_lmer_mood_mean)
```

```{r}
ee1 <- as.data.frame(Effect(c("phase", "Allocation"),mod_mood_mean_pos))

stat.test <- as.data.frame(round(summary(mod_mood_mean_pos)$coefficients,3))[16:19,]%>%
  rename(p_val = `Pr(>|t|)`)

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = ee1$upper[1])%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p8 <- ggplot(ee1, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="positive mood level")+ 
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

ggplot(ee1, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = fit-se,ymax=fit+se),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="positive mood level")+ 
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```


### variability
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * phase + Age + Gender + Season + Dateseason + weekday_weekend+ (var_type|ID)

df_hlm_lmer_mood_variability <- df_hlm%>%
  select(ID,Allocation,day,phase,pos_vmu,pos_s,neg_s,Age,Gender,posLog,Season,Dateseason,weekday_weekend)%>%
  pivot_longer(c(pos_vmu,pos_s),names_pattern =  "(.*)_(.*)",names_to = c("mood_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_mood_variability$var_type <- factor(df_hlm_lmer_mood_variability$var_type)

df_hlm_lmer_mood_variability$var_type <- relevel(df_hlm_lmer_mood_variability$var_type, ref = "volatility")

mod_pos_vmu <- lmer(model_formula,data = df_hlm_lmer_mood_variability)
kable(round(summary(mod_pos_vmu)$coefficients,3))

#additional analysis
summary(lmer(val ~ Allocation * phase + Age + Gender + Season + Dateseason + weekday_weekend + (1+var_type|ID),data = df_hlm_lmer_mood_variability))
```


```{r}
ee2 <- as.data.frame(Effect(c("phase", "Allocation","var_type"),mod_pos_vmu))%>%
  filter(var_type == "volatility")

stat.test_pos_vmu <- as.data.frame(round(summary(mod_pos_vmu)$coefficients,3))[18:21,]

stat.test <- stat.test_pos_vmu%>%rename(p_val = 'Pr(>|t|)')
stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("group1"))%>%
  mutate(y.position = ee2$upper[1])%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))


#plot volatility first
p9 <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="positive mood volatility")+
  scale_y_continuous(limits = c(-5.4,-3),breaks = seq(-5.4,-3, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p9
```

## movement
### relative amplitude
```{r}
model_formula_amp <- rel_amplitude ~ Allocation * phase + posLog + pos_vmu + Age + Gender + Season + Dateseason + weekday_weekend + (1|ID)
mod_relative_amplitude <- lmer(model_formula_amp,data = df_hlm)
kable(round(summary(mod_relative_amplitude)$coefficients,3))

plot_model(mod_relative_amplitude, type = "pred",terms = c("phase", "Allocation"))

#additional analysis
summary(lmer(rel_amplitude ~ Allocation * phase +Allocation * phase + posLog + pos_vmu + Age + Gender + Season +
               Dateseason + weekday_weekend + (1|ID),data = df_hlm))
```

### raw value
```{r}
model_formula_mean <- val ~ Allocation * movement_type * phase + posLog + pos_vmu  + Age + Gender + Season + Dateseason + weekday_weekend +  (movement_type|ID)

df_hlm_lmer_movement_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,movement_L5_mean,movement_M10_mean,Age,Gender,posLog, negLog, pos_vmu,neg_vmu,Season,
         Dateseason,weekday_weekend)%>%
  pivot_longer(c(movement_L5_mean,movement_M10_mean),names_pattern =  "movement_(.*)_mean",names_to = c("movement_type"),values_to = "val")

df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")

mod_movement_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
anova(mod_movement_mean_M10)

summary(mod_movement_mean_M10)
kable(round(summary(mod_movement_mean_M10)$coefficients,3))
lme.dscore(mod_movement_mean_M10,df_hlm_lmer_movement_mean,type = "lme4")
                                                           
df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "L5")

mod_movement_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
kable(round(summary(mod_movement_mean_L5)$coefficients,3))
lme.dscore(mod_movement_mean_L5,df_hlm_lmer_movement_mean,type = "lme4")

plot_model(mod_movement_mean_M10, type = "pred", terms = c("phase", "Allocation","movement_type"))+
  scale_color_manual(values=orangeNavyPalette)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.5),
         panel.grid.minor.y = element_blank())+
  labs(title = "predicted value of movement level",y="movement level")+
  scale_y_continuous(breaks = seq(-10, 70, by = 10))

df_hlm_lmer_movement_mean$Allocation <- factor(df_hlm_lmer_movement_mean$Allocation, levels = c("lithium","control"))
kable(round(summary(lmer(model_formula_mean,data = df_hlm_lmer_movement_mean))$coefficients,3))

df_hlm_lmer_movement_mean$Allocation <- relevel(df_hlm_lmer_movement_mean$Allocation, ref = "control")

```


```{r}
# Plot Model using another method
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")
ee1 <- as.data.frame(Effect(c("phase", "Allocation","movement_type"),mod_movement_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_movement_mean_M10)$coefficients,3))[20:23,]
stat.test_L5 <- as.data.frame(round(summary(mod_movement_mean_L5)$coefficients,3))[20:23,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"movement_type"] <- "L5" 
stat.test[5:8,"movement_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(movement_type == "L5",ee1$upper[11],if_else(movement_type == "M10", ee1$upper[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4a <- ggplot(ee1, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "activity level",y="activity level")+ 
  scale_y_continuous(limits = c(-10,80),breaks = seq(-10, 80, by = 10))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -2)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a

p4a_M10 <- ggplot(ee1%>%filter(movement_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "daytime activity level",y="daytime activity level (a.u.)", x ="")+ 
  scale_y_continuous(limits = c(30,85),breaks = seq(30, 85, by = 10))+
  stat_pvalue_manual(stat.test%>%filter(movement_type == "M10"), label = "p_sig",vjust = -4)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a_M10
```


### variability
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + Season + Dateseason + weekday_weekend + (var_type * movement_type| ID)

df_hlm_lmer_movement_variability <- df_hlm%>%
  select(ID,Season,Allocation,day,phase,movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu,Age,Gender,posLog, negLog, pos_vmu,neg_vmu,
         Dateseason,weekday_weekend)%>%
  pivot_longer(c(movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu),names_pattern =  "movement_(.*)_(.*)",names_to = c("movement_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_movement_variability$var_type <- factor(df_hlm_lmer_movement_variability$var_type)
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "noise")
df_hlm_lmer_movement_variability$movement_type <- factor(df_hlm_lmer_movement_variability$movement_type)
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

mod_movement_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
round(summary(mod_movement_var_s_M10)$coefficients,4)
lme.dscore(mod_movement_var_s_M10,df_hlm_lmer_movement_variability,type = "lme4")

df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
```

*Conclusion: lithium increased volatility of M10 and L5 by week 4.*
*Conclusion: Lithium increases daytime volatility and decreases nighttime volatility of time*


```{r}
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
ee2 <- as.data.frame(Effect(c("phase", "Allocation","movement_type","var_type"),mod_movement_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_movement_var_s_M10)$coefficients,3))[23:26,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_movement_var_s_L5)$coefficients,3))[23:26,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_movement_var_vmu_M10)$coefficients,3))[23:26,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_movement_var_vmu_L5)$coefficients,3))[23:26,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"movement_type"] <- "M10" 
stat.test[c(5:8,13:16),"movement_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("movement_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility",ee2$upper[1],if_else(var_type == "noise", ee2$upper[21],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p11a <- ggplot(ee2%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="activity noise")+
  scale_y_continuous(limits = c(-2,-1),breaks = seq(-2,-1, by = 0.2))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -3)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))


#plot volatility first
p11b <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="activity volatility")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p11a/p11b

ggsave("../figs/R3_hlm_movement_variability.png",width = 7 ,height=7,dpi = 300)

p11b_M10 <- ggplot(ee2%>%filter(var_type == "volatility", movement_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "daytime activity volatility",y="daytime activity volatility",x="")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", movement_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```


## time
### raw value
```{r}
model_formula_mean <- val ~ Allocation * time_type * phase + posLog + pos_vmu + Age + Gender  + Season + Dateseason + weekday_weekend + (time_type|ID)

df_hlm_lmer_time_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,time_L5_mean,time_M10_mean,Age,Gender,posLog,negLog, pos_vmu,Season, Dateseason, weekday_weekend)%>%
  pivot_longer(c(time_L5_mean,time_M10_mean),names_pattern =  "time_(.*)_mean",names_to = c("time_type"),values_to = "val")

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")

mod_time_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_M10)$coefficients,3))
lme.dscore(mod_time_mean_M10,df_hlm_lmer_time_mean,type = "lme4")

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "L5")

mod_time_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_L5)$coefficients,3))
lme.dscore(mod_time_mean_L5,df_hlm_lmer_time_mean,type = "lme4")

plot_model(mod_time_mean_M10, type = "pred", terms = c("phase", "Allocation","time_type"))+
  scale_color_manual(values=orangeNavyPalette)+
  theme_bw()+
  labs(title = "predicted value of onset time",y="onset time")
```

```{r}
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")
ee3 <- as.data.frame(Effect(c("phase", "Allocation","time_type"),mod_time_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_time_mean_M10)$coefficients,3))[20:23,]
stat.test_L5 <- as.data.frame(round(summary(mod_time_mean_L5)$coefficients,3))[20:23,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"time_type"] <- "L5" 
stat.test[5:8,"time_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee3[ee3$phase != "pre" & ee3$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(time_type == "L5",ee3$upper[11],if_else(time_type == "M10", ee3$upper[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4b <- ggplot(ee3, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "activity onset time",y="activity onset time (hrs)")+ 
  scale_y_continuous(limits = c(10,30),breaks = seq(10,30, by = 2.5))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -2)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b

p4b_M10 <- ggplot(ee3%>%filter(time_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "daytime activity onset time",y="daytime activity onset time (hrs)",x="")+ 
  scale_y_continuous(limits = c(8,16),breaks = seq(8, 16, by = 2))+
  stat_pvalue_manual(stat.test%>%filter(time_type == "M10"), label = "p_sig",vjust = -4)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b_M10
```

### variability 
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * time_type * phase + posLog + pos_vmu + Age + Gender + Season + Dateseason + weekday_weekend + (var_type * time_type|ID)

df_hlm_lmer_time_variability <- df_hlm%>%
  select(ID,Allocation,day,phase,time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu,Age,Gender,Season,posLog, negLog, pos_vmu,neg_vmu,
         Dateseason,weekday_weekend)%>%
  pivot_longer(c(time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu),names_pattern =  "time_(.*)_(.*)",names_to = c("time_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_time_variability$var_type <- factor(df_hlm_lmer_time_variability$var_type)
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- factor(df_hlm_lmer_time_variability$time_type)
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

mod_time_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_M10)$coefficients,3))
lme.dscore(mod_time_var_s_M10,df_hlm_lmer_time_variability,type = "lme4")

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

#same model, different reference level
mod_time_var_vmu_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_vmu_M10)$coefficients,3))
lme.dscore(mod_time_var_vmu_M10,df_hlm_lmer_time_variability,type = "lme4")

# #same model, different reference level
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")

mod_time_var_s_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_L5)$coefficients,3))
lme.dscore(mod_time_var_s_L5,df_hlm_lmer_time_variability,type = "lme4")

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")

df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")
mod_time_var_vmu_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_vmu_L5)$coefficients,3))
lme.dscore(mod_time_var_vmu_L5,df_hlm_lmer_time_variability,type = "lme4")
```

```{r}
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")
ee4 <- as.data.frame(Effect(c("phase", "Allocation","time_type","var_type"),mod_time_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_time_var_s_M10)$coefficients,3))[23:26,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_time_var_s_L5)$coefficients,3))[23:26,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_time_var_vmu_M10)$coefficients,3))[23:26,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_time_var_vmu_L5)$coefficients,3))[23:26,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"time_type"] <- "M10" 
stat.test[c(5:8,13:16),"time_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee4[ee4$phase != "pre" & ee4$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("time_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility" & time_type == "L5",ee4$upper[11],if_else(var_type == "volatility" & time_type == "M10", ee4$upper[1],if_else(var_type == "noise" & time_type == "L5",ee4$upper[36],if_else(var_type == "noise" & time_type == "M10",ee4$upper[21],0)))))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p12a <- ggplot(ee4%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement noise")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

#plot volatility first
p12b <- ggplot(ee4%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement volatility")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p12a/p12b
ggsave("../figs/R3_hlm_time_variability.png",width = 7 ,height=7,dpi = 300)

p12b_M10 <- ggplot(ee4%>%filter(var_type == "volatility", time_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=orangeNavyPalette)+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "daytime onset time volatility",y="daytime onset time volatility",x="")+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", time_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```



# print manuscript graphs
```{r manuscript figs}
p4a_M10 + p11b_M10+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/R3_movement.png",width = 7 ,height=3,dpi = 300)

p4b_M10 + p12b_M10+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/R3_time.png",width = 7 ,height=3,dpi = 300)

(p8 + p9) / (p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10) +
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/R3_movement_n_time_n_pa.png",width = 7 ,height=10,dpi = 300)

p8 + p9+
  plot_annotation(tag_levels = c("a"))
ggsave("../figs/mood_variability.png",width = 7 ,height=3,dpi = 300)
```


<!-- # correlating change in vmu and mean -->

<!-- ```{r} -->
<!-- df_hlm$phase <- factor(df_hlm$phase, labels = c("run-in","week 1","week 2","week 3","week 4")) -->

<!-- cA1 <- lmer(time_M10_mean ~ Allocation * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA1) -->

<!-- cA2 <- lmer(pos_mean ~ Allocation * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA2) -->

<!-- cA3 <- lmer(pos_mean ~ Allocation * time_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cA3) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- cB1 <- lmer(time_M10_vmu ~ Allocation * movement_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB1) -->
<!-- pC1 <- plot_model(cB1, type = "pred", terms = c("movement_M10_vmu","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity volatility", -->
<!--        y = "activity onset time volatility") -->
<!-- pC1$facet$params$nrow=1 -->

<!-- cB2 <- lmer(pos_vmu ~ Allocation * movement_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB2) -->
<!-- pC2 <- plot_model(cB2, type = "pred", terms = c("movement_M10_vmu","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity volatility", -->
<!--        y = "PA volatility")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC2$facet$params$nrow=1 -->

<!-- cB3 <- lmer(pos_vmu ~ Allocation * time_M10_vmu * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cB3) -->
<!-- pC3 <- plot_model(cB3, type = "pred", terms = c("time_M10_vmu","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time volatility", -->
<!--        y = "PA volatility")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC3$facet$params$nrow=1 -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pC1+pC2+pC3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- cC1 <- lmer(time_M10_mean ~ Allocation * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC1) -->
<!-- pC1 <- plot_model(cC1, type = "pred", terms = c("movement_M10_mean","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity", -->
<!--        y = "activity onset time") -->
<!-- pC1$facet$params$nrow=1 -->

<!-- cC2 <- lmer(posLog ~ Allocation * movement_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC2) -->
<!-- pC2 <- plot_model(cC2, type = "pred", terms = c("movement_M10_mean","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity", -->
<!--        y = "PA")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC2$facet$params$nrow=1 -->

<!-- cC3 <- lmer(posLog ~ Allocation * time_M10_mean * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cC3) -->
<!-- pC3 <- plot_model(cC3, type = "pred", terms = c("time_M10_mean","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time", -->
<!--        y = "PA")+ -->
<!--   theme(legend.position = "none") -->

<!-- pC3$facet$params$nrow=1 -->

<!-- pC1+pC2+pC3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope_rawval.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- cD1 <- lmer(time_M10_s ~ Allocation * movement_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD1) -->
<!-- pD1 <- plot_model(cD1, type = "pred", terms = c("movement_M10_s","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime movement noise", -->
<!--        y = "movement onset time noise") -->
<!-- pD1$facet$params$nrow=1 -->

<!-- cD2 <- lmer(pos_s ~ Allocation * movement_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD2) -->
<!-- pD2 <- plot_model(cD2, type = "pred", terms = c("movement_M10_s","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime movement noise", -->
<!--        y = "PA noise")+ -->
<!--   theme(legend.position = "none") -->

<!-- pD2$facet$params$nrow=1 -->

<!-- cD3 <- lmer(pos_s ~ Allocation * time_M10_s * phase + Age + Gender + (1|ID),data = df_hlm) -->
<!-- summary(cD3) -->
<!-- pD3 <- plot_model(cD3, type = "pred", terms = c("time_M10_s","Allocation","phase"), show.data = F)+ -->
<!--   scale_color_manual(values=orangeNavyPalette)+ -->
<!--   scale_fill_manual(values=orangeNavyPalette)+ -->
<!--   labs(title = "", -->
<!--        x = "daytime activity onset time noise", -->
<!--        y = "PA noise")+ -->
<!--   theme(legend.position = "none") -->

<!-- pD3$facet$params$nrow=1 -->

<!-- pD1+pD2+pD3+ -->
<!--   plot_layout(nrow = 3)+ -->
<!--   plot_annotation(tag_levels = c("a")) -->

<!-- ggsave("../figs/FIG5_change_slope_noise.png",width = 7 ,height=8,dpi = 300) -->
<!-- ``` -->

<!-- # are changes correlated? -->

<!-- ```{r} -->
<!-- change <- df_hlm%>% -->
<!--   group_by(ID, Allocation,phase)%>% -->
<!--   summarise_at(vars(movement_L5_mean:negLog),~mean(.x, na.rm = T))%>% -->
<!--   pivot_longer(movement_L5_mean:negLog, names_to = "var", values_to = "val")%>% -->
<!--   pivot_wider(names_from = "phase", values_from = "val")%>% -->
<!--   rowwise()%>% -->
<!--   mutate(post4 = ifelse(!is.na(post4),post4, -->
<!--                          ifelse(!is.na(post3),post3, -->
<!--                                 ifelse(!is.na(post2), -->
<!--                                        post2, -->
<!--                                        ifelse(!is.na(post1), -->
<!--                                               post1,NA)))))%>% -->
<!--   pivot_longer(pre:post4,names_to = "phase", values_to = "val")%>% -->
<!--   pivot_wider(names_from = "var", values_from = "val")%>% -->
<!--   filter(phase %in% c("pre","post4"))%>% -->
<!--   pivot_wider(names_from = phase, values_from = movement_L5_mean:negLog, -->
<!--               names_sep = "_")%>% -->
<!--   mutate(L5_mean_diff = movement_L5_mean_post4 - movement_L5_mean_pre, -->
<!--          L5_noise_diff = movement_L5_s_post4 - movement_L5_s_pre, -->
<!--          L5_volatility_diff = movement_L5_vmu_post4 - movement_M10_vmu_pre, -->
<!--          M10_mean_diff = movement_M10_mean_post4 - movement_M10_mean_pre, -->
<!--          M10_noise_diff = movement_M10_s_post4 - movement_M10_s_pre, -->
<!--          M10_volatility_diff = movement_M10_vmu_post4 - movement_M10_vmu_pre, -->
<!--          time_L5_mean_diff = time_L5_mean_post4 - time_L5_mean_pre, -->
<!--          time_L5_noise_diff = time_L5_s_post4 - time_L5_s_pre, -->
<!--          time_L5_volatility_diff = time_L5_vmu_post4 - time_M10_vmu_pre, -->
<!--          time_M10_mean_diff = time_M10_mean_post4 - time_M10_mean_pre, -->
<!--          time_M10_noise_diff = time_M10_s_post4 - time_M10_s_pre, -->
<!--          time_M10_volatility_diff = time_M10_vmu_post4 - time_M10_vmu_pre, -->
<!--          pos_mean_diff = pos_mean_post4 - pos_mean_pre, -->
<!--          pos_noise_diff = pos_s_post4 - pos_s_pre, -->
<!--          pos_volatility_diff = pos_vmu_post4 - pos_vmu_pre, -->
<!--          neg_mean_diff = neg_mean_post4 - neg_mean_pre, -->
<!--          neg_noise_diff = neg_s_post4 - neg_s_pre, -->
<!--          neg_volatility_diff = neg_vmu_post4 - neg_vmu_pre)%>% -->
<!--   select(ID,Allocation,L5_mean_diff:neg_volatility_diff) -->
<!-- ``` -->

<!-- ## cross-panel -->
<!-- ```{r} -->
<!-- change_corr_lithium <- change%>% -->
<!--   filter(Allocation == "lithium")%>% -->
<!--   ungroup()%>% -->
<!--   select(M10_volatility_diff, -->
<!--          M10_mean_diff, -->
<!--          time_M10_mean_diff, -->
<!--          time_M10_volatility_diff, -->
<!--          pos_volatility_diff, -->
<!--          pos_mean_diff) -->

<!-- corr.mat1 <- round(cor(change_corr_lithium, -->
<!--                 use = "complete.obs"),1) -->
<!-- # corr.pmat1 <- as.matrix(cor_pmat(change_corr_lithium)[,2:(ncol(change_corr_lithium)+1)]) -->

<!-- c1 <- ggcorrplot::ggcorrplot(corr.mat1,    -->
<!--                        hc.order = FALSE, type = "lower", -->
<!--    outline.col = "white", -->
<!--    lab = TRUE, -->
<!--    ggtheme = ggplot2::theme_gray, -->
<!--    colors = c("navy", "white", "orange"))+ -->
<!--   labs(title = "Lithium group") -->

<!-- change_corr_control <- change%>% -->
<!--   filter(Allocation == "control")%>% -->
<!--   ungroup()%>% -->
<!--   select(M10_volatility_diff, -->
<!--          M10_mean_diff, -->
<!--          time_M10_mean_diff, -->
<!--          time_M10_volatility_diff, -->
<!--          pos_volatility_diff, -->
<!--          pos_mean_diff) -->

<!-- corr.mat2 <- round(cor(change_corr_control, -->
<!--                 use = "complete.obs"),1) -->
<!-- # corr.pmat2 <- as.matrix(cor_pmat(change_corr_control)[,2:(ncol(change_corr_control)+1)]) -->

<!-- c2 <- ggcorrplot::ggcorrplot(corr.mat2,    -->
<!--                        hc.order = FALSE, type = "lower", -->
<!--    outline.col = "white", -->
<!--    lab = TRUE, -->
<!--    ggtheme = ggplot2::theme_gray, -->
<!--    colors = c("navy", "white", "orange"))+ -->
<!--   labs(title = "Control group") -->

<!-- # c3 <- ggcorrplot::ggcorrplot(corr.mat2 - corr.mat1,    -->
<!-- #                        hc.order = FALSE, type = "lower", -->
<!-- #    outline.col = "white", -->
<!-- #    lab = TRUE, -->
<!-- #    ggtheme = ggplot2::theme_gray, -->
<!-- #    colors = c("navy", "white", "orange"))+ -->
<!-- #   labs(title = "Control - Lithium") -->
<!-- ``` -->

<!-- ```{r fig.width=10, fig.height=10} -->
<!-- c1+c2 -->
<!-- ``` -->

