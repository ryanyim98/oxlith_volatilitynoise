---
title: "Oxlith"
author: "Ryan Yan"
date: '2022-09-20'
output: html_document
---

```{r include = FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggcorrplot2)
library(patchwork)
library(ggpubr)
library(lme4)
library(lmerTest)
library(sjPlot)
library(emmeans)
library(ggpmisc)
library(PerformanceAnalytics)
library(knitr)
library(see)
library(effects)
library(brms)
library(bayestestR)
library(tidybayes)
library(modelr)
library(sjstats)
library(ggeffects)
library(mediation)
library(rstatix)
library(psych)
library(MASS)
# library(mlma)
library(DiagrammeR)
library(nlme)
```

```{r}
theme_set(theme_classic()+
          theme(text = element_text(family = "Times", size = 12)))
orangeNavyPalette = c("orange","navy")
```

```{r message=FALSE}
df_hlm_movement <- read.csv("/Users/rh/Desktop/BayesM10/data/movement_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_movement)[6:13] <- paste0("movement_",names(df_hlm_movement)[6:13])
df_hlm_time <- read.csv("/Users/rh/Desktop/BayesM10/data/time_data_HLM_-14toEnd_allparticipants.csv")
names(df_hlm_time)[6:13] <- paste0("time_",names(df_hlm_time)[6:13])
df_hlm_mood <- read.csv("/Users/rh/Desktop/BayesM10/data/mood_data_HLM_-14toEnd_allparticipants.csv")

df_hlm <- Reduce(merge, list(df_hlm_movement,df_hlm_time,df_hlm_mood))

df_demo <- read.csv("/Users/rh/Desktop/BayesM10/data/demo_info.csv")%>%
  mutate(Allocation = if_else(Allocation == "B","Lithium", "Control"))
  # filter(ID %in% unique(df_hlm$ID))

participant_num <- length(unique(df_hlm$ID))

df_hlm$Allocation[df_hlm$Allocation == "A"] <- "control"
df_hlm$Allocation[df_hlm$Allocation == "B"] <- "lithium"

# mood parameters from 0~4 to 1~5
df_hlm$pos_mean <- df_hlm$pos_mean+5
df_hlm$neg_mean <- df_hlm$neg_mean+5

# mood parameters need log transformation
df_hlm$posLog <- log(df_hlm$pos_mean+1)
df_hlm$negLog <- log(df_hlm$neg_mean+1)

#compute relative amplitude
df_hlm <- df_hlm%>%
  rowwise()%>%
  mutate(rel_amplitude  = (movement_M10_mean - movement_L5_mean)/(movement_M10_mean + movement_L5_mean))

#add season into df
df_hlm <- merge(df_hlm,df_demo[,c("ID","Season","Diagnosis")], by = "ID")
```

# demo descriptive stats
```{r}
#reorganize ethnicity
df_demo <- df_demo%>%
  mutate(Ethnicity = if_else(Ethnicity == "", "not reported", if_else(Ethnicity == "other brazilian" | Ethnicity == "Other croatian british","other",Ethnicity)))

df_control <- df_demo%>%filter(Allocation == "Control")
df_lithium <- df_demo%>%filter(Allocation == "Lithium")

table(df_demo[,c("Gender","Allocation")])
chisq.test(table(df_demo[,c("Gender","Allocation")]))

#ethnicity
table(df_demo[,c("Ethnicity","Allocation")])
chisq.test(table(df_demo[,c("Ethnicity","Allocation")]))

#age
df_demo%>%
  group_by(Allocation)%>%
  summarise(mean_Age = round(mean(Age),2),
            sd_Age = round(sd(Age),2))
t.test(df_control$Age,df_lithium$Age)

#BMI
df_demo%>%
  group_by(Allocation)%>%
  summarise(mean_BMI = round(mean(BMI),2),
            sd_BMI = round(sd(BMI),2))
t.test(df_control$BMI,df_lithium$BMI)

#mood
df_mood <- df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  group_by(ID,Allocation)%>%
  summarise(pos_mean = round(mean(pos_mean,na.rm = TRUE),2),
            neg_mean = round(mean(neg_mean,na.rm = TRUE),2))

df_mood%>%
  group_by(Allocation)%>%
  summarise(mean_pos = round(mean(pos_mean),2),
            sd_po = round(sd(pos_mean),2),
            mean_neg = round(mean(neg_mean),2),
            sd_neg = round(sd(neg_mean),2))
t.test(df_mood$pos_mean[df_mood$Allocation == "lithium"],df_mood$pos_mean[df_mood$Allocation == "control"])
t.test(df_mood$neg_mean[df_mood$Allocation == "lithium"],df_mood$neg_mean[df_mood$Allocation == "control"])

#recording days
df_demo%>%
  group_by(Allocation)%>%
  summarise(median_total.recording.days = median(total.recording.days, na.rm = TRUE))
table(df_demo[,c("total.recording.days","Allocation")])
t.test(df_lithium$total.recording.days,df_control$total.recording.days)

#missing days
df_demo%>%
  group_by(Allocation)%>%
  summarise(median_Missing.days = median(Missing.days, na.rm = TRUE))
table(df_demo[,c("Missing.days","Allocation")])
t.test(df_lithium$Missing.days,df_control$Missing.days)

#BP subtype
table(df_demo[,c("Diagnosis","Allocation")])
chisq.test(table(df_demo[,c("Diagnosis","Allocation")]))

#season
table(df_demo[,c("Season","Allocation")])
chisq.test(table(df_demo[,c("Season","Allocation")]))
```
# data inspection
## data availability
```{r}
participant_num

data_path <- "/Users/rh/Desktop/BayesM10/data/"
df_hlm_movement <- read.csv(paste0(data_path,"movement_data_HLM_-14toEnd_allparticipants.csv"))
names(df_hlm_movement)[6:13] <- paste0("movement_",names(df_hlm_movement)[6:13])

df_hlm_time <- read.csv(paste0(data_path,"time_data_HLM_-14toEnd_allparticipants.csv"))
names(df_hlm_time)[6:13] <- paste0("time_",names(df_hlm_time)[6:13])

df_hlm_mood <- read.csv(paste0(data_path,"mood_data_HLM_-14toEnd_allparticipants.csv"))

df_hlm <- Reduce(merge, list(df_hlm_movement,df_hlm_time,df_hlm_mood))

df_demo <- read.csv(paste0(data_path,"/demo_info.csv"))%>%
  mutate(Allocation = if_else(Allocation == "B","Lithium", "Control"))

participant_num <- length(unique(df_hlm$ID))

df_hlm$Allocation[df_hlm$Allocation == "A"] <- "control"
df_hlm$Allocation[df_hlm$Allocation == "B"] <- "lithium"

# mood parameters from 0~4 to 1~5
df_hlm$pos_mean <- df_hlm$pos_mean+5
df_hlm$neg_mean <- df_hlm$neg_mean+5

# mood parameters need log transformation
df_hlm$posLog <- log(df_hlm$pos_mean+1)
df_hlm$negLog <- log(df_hlm$neg_mean+1)

#compute relative amplitude
df_hlm <- df_hlm%>%
  rowwise()%>%
  mutate(rel_amplitude  = (movement_M10_mean - movement_L5_mean)/(movement_M10_mean + movement_L5_mean))

#add season into df
df_hlm <- merge(df_hlm,df_demo[,c("ID","Season","Diagnosis")], by = "ID")
```

## data availability
```{r fig.width= 6, fig.height=5, out.width="100%"}
group_N <- count(unique(df_hlm%>%
  select(ID,Allocation)),Allocation)

# data availability by week (rolling mean)
ymax = max(group_N$n)+4
p1 <- ggplot(df_hlm%>%
  filter(!is.na(movement_M10_mean))%>%
  group_by(Allocation)%>%
  count(day),
  aes(x = day, y = n, color = Allocation))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "bottom",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p2 <- ggplot(df_hlm%>%
  filter(!is.na(pos_mean))%>%
  group_by(Allocation)%>%
  count(day),
  aes(x = day, y = n, color = Allocation))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood data availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p3 <- ggplot( df_hlm%>%
  filter(!is.na(movement_M10_vmu))%>%
  group_by(Allocation)%>%
  count(day),
  aes(x = day, y = n, color = Allocation))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax-4, 
               color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Movement model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

p4 <- ggplot(df_hlm%>%
  filter(!is.na(pos_vmu))%>%
  group_by(Allocation)%>%
  count(day), aes(x = day, y = n, color = Allocation))+
  geom_line(size=1.5)+
  geom_segment(x = -14, xend = -14, y = ymax, yend = ymax -4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  geom_segment(x = 28, xend = 28, y = ymax, yend = ymax -4, color = "#999999",size=0.7, arrow =arrow(length = unit(0.3, "cm")))+
  labs(title = "Mood model output availability",
       y = "available N")+
  ylim(0,max(group_N$n)+1)+
  scale_color_manual(values = orangeNavyPalette)+
  scale_x_continuous(breaks = seq(-14,56,by = 7))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())

(p1+p2)/(p3+p4)+ plot_annotation(tag_levels = 'A')
  ggsave("/Users/rh/Desktop/BayesM10/figs/fig1_data_availability.png",width = 8 ,height=6,dpi = 300)
```

```{r}
df_hlm <- df_hlm%>%filter(day >= -14 & day <= 28)
```

## plot raw M10 data and M10 estimates
```{r}
p1 <- ggplot(df_hlm, aes(x = day, y = movement_M10_mean, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))

p2 <- ggplot(df_hlm, aes(x = day, y = movement_L5_mean, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))

p3 <- ggplot(df_hlm, aes(x = day, y = time_M10_mean, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))+scale_color_brewer(palette = "Set1")

p4 <- ggplot(df_hlm, aes(x = day, y = time_L5_mean, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))+scale_color_brewer(palette = "Set1")

(p1+p2)/(p3+p4)
```

## plot mood data
```{r}
p1 <- ggplot(df_hlm, aes(x = day, y = posLog, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))+
  scale_color_brewer(palette = "Set2")

p2 <- ggplot(df_hlm, aes(x = day, y = negLog, group = ID, color = Allocation))+
  geom_line(aes(color = Allocation))+
  scale_color_brewer(palette = "Set2")

p1/p2
```

## density plot of movement parameters
```{r}
p1d <- ggdensity(df_hlm$movement_M10_mean)+labs(title = "M10 mean",x="")+
  scale_x_continuous(breaks = seq(25,200,by = 75))
p2d <- ggdensity(df_hlm$movement_M10_s)+labs(title = "M10 noise",x="")
p3d <- ggdensity(df_hlm$movement_M10_vmu)+labs(title = "M10 volatility",x="")
p4d <- ggdensity(df_hlm$movement_M10_mu)+labs(title = "M10 mu",x="")
p5d <- ggdensity(df_hlm$movement_L5_mean)+labs(title = "L5 mean",x="")
p6d <- ggdensity(df_hlm$movement_L5_s)+labs(title = "L5 noise",x="")
p7d <- ggdensity(df_hlm$movement_L5_vmu)+labs(title = "L5 volatility",x="")
p8d <- ggdensity(df_hlm$movement_L5_mu)+labs(title = "L5 mu",x="")+
  scale_x_continuous(breaks = seq(0.1,0.5,by = 0.1))

(p1d|p2d|p3d|p4d)/(p5d|p6d|p7d|p8d)+
  plot_annotation(title = "distribution of movement parameters")

 ggsave("/Users/rh/Desktop/BayesM10/figs/fig_params_distribution_movement.png",width = 8 ,height=5,dpi = 300)
```

## density plot of movement onset time parameters
```{r}
p1d <- ggdensity(df_hlm$time_M10_mean, linetype = "dashed")+labs(title = "M10 time mean",x="")
p2d <- ggdensity(df_hlm$time_M10_s, linetype = "dashed")+labs(title = "M10 time noise",x="")
p3d <- ggdensity(df_hlm$time_M10_vmu, linetype = "dashed")+labs(title = "M10 time volatility",x="")
p4d <- ggdensity(df_hlm$time_M10_mu, linetype = "dashed")+labs(title = "M10 time mu",x="")
p5d <- ggdensity(df_hlm$time_L5_mean, linetype = "dashed")+labs(title = "L5 time mean",x="")
p6d <- ggdensity(df_hlm$time_L5_s, linetype = "dashed")+labs(title = "L5 time noise",x="")
p7d <- ggdensity(df_hlm$time_L5_vmu, linetype = "dashed")+labs(title = "L5 time volatility",x="")
p8d <- ggdensity(df_hlm$time_L5_mu, linetype = "dashed")+labs(title = "L5 time mu",x="")+
  scale_x_continuous(breaks = seq(0,1,by = 0.3))

(p1d|p2d|p3d|p4d)/(p5d|p6d|p7d|p8d)+
  plot_annotation(title = "distribution of onset time parameters")

 ggsave("/Users/rh/Desktop/BayesM10/figs/fig_params_distribution_onsetTime.png",width = 8 ,height=5,dpi = 300)
```
## density plot of mood
```{r}
p1d <- ggdensity(df_hlm$pos_mean)+labs(title = "PA")
p2d <- ggdensity(df_hlm$neg_mean)+labs(title = "NA")
p3d <- ggdensity(df_hlm$posLog)+labs(title = "log PA")
p4d <- ggdensity(df_hlm$negLog)+labs(title = "log NA")

(p1d|p2d)/(p3d|p4d)
```

```{r}
df_hlm$phase[df_hlm$day < 1] <- "pre"
df_hlm$phase[df_hlm$day >= 1 & df_hlm$day <= 7] <- "post1"
df_hlm$phase[df_hlm$day >= 8 & df_hlm$day <= 14] <- "post2"
df_hlm$phase[df_hlm$day >= 15 & df_hlm$day <= 21] <- "post3"
df_hlm$phase[df_hlm$day >= 22 & df_hlm$day <= 28] <- "post4"

# df_hlm$phase[df_hlm$day >= 29 & df_hlm$day <= 35] <- "post5"
# df_hlm$phase[df_hlm$day >= 36] <- "post6"
df_hlm$phase <- factor(df_hlm$phase, levels = c("pre","post1","post2","post3","post4")) #,"post5","post6"
```

# correlation among variables
#correlation heatmap
```{r}
find.corr <- function(df,a,b){
  #df is the dataframe
  #a(IV) and b(DV) are the column index to which the model is fitted
  iv <- names(df)[a]
  dv <- names(df)[b]
  my.formula = as.formula(paste0("scale(",iv,") ~ scale(",dv,") + (1 + scale(",dv,") |ID)"))
  my.lme <- summary(lmer(my.formula,df))
  return(c(my.lme$coefficients[2,1],my.lme$coefficients[2,5])) #beta, p
}
```

```{r}
df_hlm_corr <- df_hlm%>%
  select(ID,day, Allocation,movement_L5_mean,movement_M10_mean,
         time_L5_mean,time_M10_mean,posLog,negLog,
         movement_L5_vmu,movement_M10_vmu,
         time_L5_vmu,time_M10_vmu,
         pos_vmu,neg_vmu,
         movement_L5_s,movement_M10_s,
         time_L5_s,time_M10_s,
         pos_s,neg_s)%>%
  rename(L5 = movement_L5_mean,
         M10 = movement_M10_mean,
         timeL5 = time_L5_mean,
         timeM10 = time_M10_mean,
         logPA = posLog,
         logNA = negLog,
         timeL5_vmu = time_L5_vmu,
         timeM10_vmu = time_M10_vmu,
         L5_vmu = movement_L5_vmu,
         M10_vmu = movement_M10_vmu,
         PA_vmu = pos_vmu,
         NA_vmu = neg_vmu,
         L5_s = movement_L5_s,
         M10_s = movement_M10_s,
         timeL5_s = time_L5_s,
         timeM10_s = time_M10_s,
         PA_s = pos_s,
         NA_s = neg_s)

num.row = ncol(df_hlm_corr)-3

my.corr.mat <- matrix(nrow = num.row, ncol = num.row)
my.corr.pmat <- matrix(nrow = num.row, ncol = num.row)

rownames(my.corr.mat) <- names(df_hlm_corr)[4:(num.row+3)]
colnames(my.corr.mat) <- names(df_hlm_corr)[4:(num.row+3)]
rownames(my.corr.pmat) <- names(df_hlm_corr)[4:(num.row+3)]
colnames(my.corr.pmat) <- names(df_hlm_corr)[4:(num.row+3)]

for (i in 1:num.row){
  my.corr.mat[i,i] = 1
  my.corr.pmat[i,i] = 0
}

for (a in 4:(num.row+3)){
  for (b in 4:(num.row+3)){
    if (a != b){
      temp_out <- find.corr(df_hlm_corr,a,b)
      my.corr.mat[a-3,b-3] = temp_out[1]
      my.corr.pmat[a-3,b-3] = temp_out[2]
    }
  }
}

col1 <- colorRampPalette(c("#7F0000", "red", "#FF7F00", "yellow", "white",
                           "cyan", "#007FFF", "blue", "#00007F"))

ggcorrplot2::ggcorrplot.mixed(my.corr.mat, upper = "ellipse",lower = "number",p.mat = my.corr.pmat,insig = "label_sig",sig.lvl = c(0.05, 0.01, 0.001))+ 
  scale_fill_gradientn(colours = col1(10), limits = c(-1, 1),
                                guide = guide_colorbar(
                                  direction = "horizontal",
                                  title = "",
                                  nbin = 1000,
                                  ticks.colour = "black",
                                  frame.colour = "black",
                                  barwidth = 15,
                                  barheight = 1.5)) +
  scale_colour_gradientn(colours = col1(10), limits = c(-1, 1),
                       guide = guide_colorbar(
                         direction = "horizontal",
                         title = "",
                         nbin = 1000,
                         ticks.colour = "black",
                         frame.colour = "black",
                         barwidth = 15,
                         barheight = 1.5))+
  theme(legend.position = "bottom")

round(my.corr.mat,3)
round(my.corr.pmat,3)

ggsave("/Users/rh/Desktop/BayesM10/figs/corr_plot_all.png",width = 8 ,height=8,dpi = 300)
```

```{r}
df_hlm_corr2 <- df_hlm%>%
  select(ID,day, Allocation,movement_M10_mean,
         time_M10_mean,posLog,negLog,
         movement_M10_vmu,
         time_M10_vmu,
         pos_vmu,neg_vmu,
         movement_M10_s,
         time_M10_s,
         pos_s,neg_s)%>%
  rename(M10 = movement_M10_mean,
         timeM10 = time_M10_mean,
         logPA = posLog,
         logNA = negLog,
         timeM10_vmu = time_M10_vmu,
         M10_vmu = movement_M10_vmu,
         PA_vmu = pos_vmu,
         NA_vmu = neg_vmu,
         M10_s = movement_M10_s,
         timeM10_s = time_M10_s,
         PA_s = pos_s,
         NA_s = neg_s)

num.row2 = ncol(df_hlm_corr2)-3

my.corr.mat2 <- matrix(nrow = num.row2, ncol = num.row2)
my.corr.pmat2 <- matrix(nrow = num.row2, ncol = num.row2)

rownames(my.corr.mat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
colnames(my.corr.mat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
rownames(my.corr.pmat2) <- names(df_hlm_corr2)[4:(num.row2+3)]
colnames(my.corr.pmat2) <- names(df_hlm_corr2)[4:(num.row2+3)]

for (i in 1:num.row2){
  my.corr.mat2[i,i] = 1
  my.corr.pmat2[i,i] = 0
}

for (a in 4:(num.row2+3)){
  for (b in 4:(num.row2+3)){
    if (a != b){
      temp_out <- find.corr(df_hlm_corr2,a,b)
      my.corr.mat2[a-3,b-3] = temp_out[1]
      my.corr.pmat2[a-3,b-3] = temp_out[2]
    }
  }
}

# ggcorrplot2::ggcorrplot.mixed(my.corr.mat2, upper = "ellipse",lower = "number",p.mat = my.corr.pmat2,insig = "label_sig",sig.lvl = c(0.05, 0.01, 0.001))+ 
#   scale_fill_gradientn(colours = col1(10), limits = c(-1, 1),
#                                 guide = guide_colorbar(
#                                   direction = "horizontal",
#                                   title = "",
#                                   nbin = 1000,
#                                   ticks.colour = "black",
#                                   frame.colour = "black",
#                                   barwidth = 15,
#                                   barheight = 1.5)) +
#   scale_colour_gradientn(colours = col1(10), limits = c(-1, 1),
#                        guide = guide_colorbar(
#                          direction = "horizontal",
#                          title = "",
#                          nbin = 1000,
#                          ticks.colour = "black",
#                          frame.colour = "black",
#                          barwidth = 15,
#                          barheight = 1.5))+
#   theme(legend.position = "bottom")

ggcorrplot::ggcorrplot(my.corr.mat2,p.mat = my.corr.pmat2,insig = "blank",colors=c("orange", "white", "navy"),lab = TRUE, digits = 1)+
  theme(text = element_text(family = "Times", size = 12))

round(my.corr.mat2,3)
round(my.corr.pmat2,3)
ggsave("/Users/rh/Desktop/BayesM10/figs/man_corr_plot.png",width = 6 ,height=6,dpi = 300)

```

## pre-randomisation check MANOVA
```{r}
# check M10
df1 <- df_hlm%>%
  dplyr::filter(phase == "pre")%>%
  group_by(Allocation,ID)%>%
  summarise_at(vars(movement_L5_mean:time_M10_mu), ~mean(.x, na.rm = TRUE))

m01 <- manova(cbind(movement_M10_mean,movement_M10_vmu,time_M10_mean,time_M10_vmu) ~ Allocation, data =df1)
summary.aov(m01)
```

None of the parameters were different pre-randomization.

# visual inspection of group values
```{r  fig.height=8,fig.width=4}
baseline_values <- df_hlm%>%
  ungroup()%>%
  filter(day <= 0)%>%
  group_by(ID)%>%
  summarise_at(vars(movement_L5_mean:neg_mu), ~ mean(.x, na.rm = TRUE))

names(baseline_values)[2:length(names(baseline_values))] <- paste0("baseline_",names(baseline_values)[2:length(names(baseline_values))])

df_hlm_baseline <- left_join(df_hlm, baseline_values, by = "ID")%>%
  filter(day>0,day <= 28)

df_hlm_baseline <- df_hlm_baseline%>%
  mutate(movement_M10_mean = movement_M10_mean - baseline_movement_M10_mean,
         movement_M10_vmu = movement_M10_vmu - baseline_movement_M10_vmu,
         movement_L5_vmu = movement_L5_vmu - baseline_movement_L5_vmu,
         movement_M10_s = movement_M10_s - baseline_movement_M10_s,
         movement_L5_s = movement_L5_s - baseline_movement_L5_s,
         time_M10_mean = time_M10_mean - baseline_time_M10_mean,
         time_M10_vmu = time_M10_vmu - baseline_time_M10_vmu,
         time_L5_vmu = time_L5_vmu - baseline_time_L5_vmu,
         time_M10_s = time_M10_s - baseline_time_M10_s,
         time_L5_s = time_L5_s - baseline_time_L5_s,
         pos_vmu = pos_vmu - baseline_pos_vmu,
         neg_vmu = neg_vmu - baseline_neg_vmu,
         pos_s = pos_s - baseline_pos_s,
         neg_s = neg_s - baseline_neg_s)%>%
  group_by(ID,Allocation,phase)%>%
  summarise_at(vars(movement_L5_mean:neg_mu), ~ mean(.x, na.rm = TRUE))

p1<- ggplot(df_hlm_baseline, aes(x = phase, y = movement_M10_mean, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange")+
  labs(title = "M10 - baseline")+
  scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

p2<- ggplot(df_hlm_baseline, aes(x = phase, y = movement_M10_vmu, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange")+
  labs(title = "M10 volatility - baseline")+
  scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

p3<- ggplot(df_hlm_baseline, aes(x = phase, y = time_M10_mean, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange",shape=1)+
  labs(title = "M10 time - baseline")+
  scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

p4<- ggplot(df_hlm_baseline, aes(x = phase, y = time_M10_vmu, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange",shape=1)+
  labs(title = "M10 time volatility - baseline")+
  scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

p5 <- ggplot(df_hlm_baseline, aes(x = phase, y = pos_vmu, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange")+
  labs(title = "PA vmu - baseline")+
    scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

p6 <- ggplot(df_hlm_baseline, aes(x = phase, y = neg_vmu, color = Allocation))+
  geom_jitter(aes(color = Allocation,shape=Allocation),width=0.2, alpha = 0.3)+
  stat_summary(aes(color = Allocation),geom = "pointrange")+
  labs(title = "NA vmu - baseline")+
    scale_shape_manual(values=c(2,3))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()

(p1+p2)/(p3+p4)/(p5+p6)+
  plot_annotation(title = "Parameter group values (referenced to pre-randomization phase)")
 # ggsave("/Users/rh/Desktop/BayesM10/figs/fig_params_value_by_week_movement.png",width = 10 ,height=8,dpi = 300)
```

<!-- ```{r} -->
<!-- d1 <- df_hlm_baseline_bars%>%filter(type == "movement") -->
<!-- aov1 <- aov(vmu ~ movement * Allocation + Error(movement/ID) ,d1) -->
<!-- summary(aov1) -->
<!-- pairs(emmeans(aov1, ~Allocation|movement),test = "bon") -->

<!-- d2 <- df_hlm_baseline_bars%>%filter(type == "onset_time") -->
<!-- aov2 <- aov(vmu ~ movement * Allocation + Error(movement/ID) ,d2) -->
<!-- summary(aov2) -->
<!-- pairs(emmeans(aov2, ~Allocation|movement),test = "bon") -->

<!-- aov3 <- aov(noise ~ movement * Allocation + Error(1/ID) ,df_hlm_baseline_bars_noise%>%filter(type == "movement")) -->
<!-- summary(aov3) -->

<!-- aov4 <- aov(noise ~ movement * Allocation + Error(1/ID) ,df_hlm_baseline_bars_noise%>%filter(type == "onset_time")) -->
<!-- summary(aov4) -->
<!-- ``` -->

#linear mixed model
## mood
### raw value
```{r}
model_formula_mean <- val ~ Allocation * mood_type * phase + Age + Gender + (mood_type|ID)

df_hlm_lmer_mood_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,posLog,negLog,Age,Gender,posLog, negLog, Season)%>%
  pivot_longer(c(posLog,negLog),names_pattern =  "(.*)Log",names_to = c("mood_type"),values_to = "val")

df_hlm_lmer_mood_mean$mood_type <- factor(df_hlm_lmer_mood_mean$mood_type)
df_hlm_lmer_mood_mean$mood_type <- relevel(df_hlm_lmer_mood_mean$mood_type, ref = "pos")

mod_mood_mean_pos <- lmer(model_formula_mean,data = df_hlm_lmer_mood_mean)
kable(round(summary(mod_mood_mean_pos)$coefficients,3))

df_hlm_lmer_mood_mean$mood_type <- relevel(df_hlm_lmer_mood_mean$mood_type, ref = "neg")

mod_mood_mean_neg <- lmer(model_formula_mean,data = df_hlm_lmer_mood_mean)
kable(round(summary(mod_mood_mean_neg)$coefficients,3))
```

```{r}
my.df <- df_hlm_lmer_mood_mean%>%
  filter(phase %in% c("pre","post4"))%>%
  group_by(phase, ID, Allocation, mood_type)%>%
  summarise(val = mean(val, na.rm = T))

ggplot(my.df, aes(x = phase, y = val, group = ID, color = Allocation))+
  geom_point(alpha = 0.3)+
  geom_line(alpha = 0.3)+
  facet_wrap(~ mood_type + Allocation)+
  scale_color_manual(values = c("orange","navy"))+
  stat_summary(aes(group = phase),color = "black")

#d'
d_ <- df_hlm_lmer_mood_mean%>%
  filter(phase %in% c("post4"))%>%
  group_by(Allocation, mood_type)%>%
  summarise(mean = mean(val, na.rm = T),
            sd = sd(val, na.rm = T))%>%
  pivot_wider(names_from = "Allocation", values_from = c("mean","sd"))%>%
  mutate(dPrime = (mean_lithium - mean_control)/sd_lithium)
```

```{r}
# Plot Model using another method
df_hlm_lmer_mood_mean$mood_type <- relevel(df_hlm_lmer_mood_mean$mood_type, ref = "pos")
ee1 <- as.data.frame(Effect(c("phase", "Allocation","mood_type"),mod_mood_mean_pos))

stat.test_pos <- as.data.frame(round(summary(mod_mood_mean_pos)$coefficients,3))[11:14,]
stat.test_neg <- as.data.frame(round(summary(mod_mood_mean_neg)$coefficients,3))[11:14,]
stat.test <- rbind(stat.test_pos,stat.test_neg)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"mood_type"] <- "pos" 
stat.test[5:8,"mood_type"] <- "neg" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(mood_type == "neg",ee1$fit[1],if_else(mood_type == "pos", ee1$fit[11],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p8 <- ggplot(ee1, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~mood_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="mood level")+ 
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -6)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p8
ggsave("/Users/rh/Desktop/BayesM10/figs/hlm_mood_val.png",width = 6 ,height=4,dpi = 300)

p8_pos <- ggplot(ee1%>%
                   filter(mood_type == "pos"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="PA level")+ 
  stat_pvalue_manual(stat.test%>%
                   filter(mood_type == "pos"), label = "p_sig",vjust = -6)+
  scale_y_continuous(limits = c(2,2.8))+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p8_pos
```


### variability
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * mood_type * phase + Age + Gender + (var_type * mood_type|ID)

df_hlm_lmer_mood_variability <- df_hlm%>%
  select(ID,Allocation,day,phase,pos_vmu,neg_vmu,pos_s,neg_s,Age,Gender,posLog, negLog)%>%
  pivot_longer(c(pos_vmu,neg_vmu,pos_s,neg_s),names_pattern =  "(.*)_(.*)",names_to = c("mood_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_mood_variability$var_type <- factor(df_hlm_lmer_mood_variability$var_type)
df_hlm_lmer_mood_variability$mood_type <- factor(df_hlm_lmer_mood_variability$mood_type)

df_hlm_lmer_mood_variability$var_type <- relevel(df_hlm_lmer_mood_variability$var_type, ref = "volatility")
df_hlm_lmer_mood_variability$mood_type <- relevel(df_hlm_lmer_mood_variability$mood_type, ref = "pos")

#same model, different reference level
mod_pos_vmu <- lmer(model_formula,data = df_hlm_lmer_mood_variability)
kable(round(summary(mod_pos_vmu)$coefficients,3))

df_hlm_lmer_mood_variability$var_type <- relevel(df_hlm_lmer_mood_variability$var_type, ref = "volatility")
df_hlm_lmer_mood_variability$mood_type <- relevel(df_hlm_lmer_mood_variability$mood_type, ref = "neg")

mod_neg_vmu <- lmer(model_formula,data = df_hlm_lmer_mood_variability)
kable(round(summary(mod_neg_vmu)$coefficients,3))

plot_model(mod_neg_vmu, type = "pred", terms = c("phase", "Allocation","mood_type","var_type"))
```


```{r}
df_hlm_lmer_mood_variability$var_type <- relevel(df_hlm_lmer_mood_variability$var_type, ref = "volatility")
df_hlm_lmer_mood_variability$mood_type <- relevel(df_hlm_lmer_mood_variability$mood_type, ref = "pos")
ee2 <- as.data.frame(Effect(c("phase", "Allocation","mood_type","var_type"),mod_pos_vmu))%>%
  filter(var_type == "volatility")

stat.test_pos_vmu <- as.data.frame(round(summary(mod_pos_vmu)$coefficients,3))[14:17,]
stat.test_neg_vmu <- as.data.frame(round(summary(mod_neg_vmu)$coefficients,3))[14:17,]

stat.test <- Reduce(rbind,list(stat.test_pos_vmu,stat.test_neg_vmu))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4),"mood_type"] <- "pos" 
stat.test[c(5:8),"mood_type"] <- "neg" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("mood_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility",ee2$fit[1],if_else(var_type == "noise", ee2$fit[21],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))


#plot volatility first
p9 <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~mood_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="mood volatility")+
  scale_y_continuous(limits = c(-5.4,-3),breaks = seq(-5.4,-3, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = -5)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p9
ggsave("/Users/rh/Desktop/BayesM10/figs/mood_variability.png",width = 7 ,height=3,dpi = 300)

p9_pos <- ggplot(ee2%>%filter(var_type == "volatility", mood_type == "pos"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="mood volatility")+
  scale_y_continuous(limits = c(-5.0,-3),breaks = seq(-5.0,-3, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", mood_type == "pos"),label = "p_sig",vjust = -5)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p9_pos
```
## movement
### relative amplitude
```{r}
model_formula_amp <- rel_amplitude ~ Allocation * phase + posLog + pos_vmu + Age + Gender + (1|ID)
mod_relative_amplitude <- lmer(model_formula_amp,data = df_hlm)
kable(round(summary(mod_relative_amplitude)$coefficients,3))

plot_model(mod_relative_amplitude, type = "pred",terms = c("phase", "Allocation"))
```

### raw value
```{r}
model_formula_mean <- val ~ Allocation * movement_type * phase + posLog + pos_vmu  + Age + Gender + (movement_type|ID)

df_hlm_lmer_movement_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,movement_L5_mean,movement_M10_mean,Age,Gender,posLog, negLog, pos_vmu,Season)%>%
  pivot_longer(c(movement_L5_mean,movement_M10_mean),names_pattern =  "movement_(.*)_mean",names_to = c("movement_type"),values_to = "val")

df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")

mod_movement_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
kable(round(summary(mod_movement_mean_M10)$coefficients,3))

df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type)
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "L5")

mod_movement_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean)
kable(round(summary(mod_movement_mean_L5)$coefficients,3))

plot_model(mod_movement_mean_M10, type = "pred", terms = c("phase", "Allocation","movement_type"))+
  scale_color_manual(values=c("orange","navy"))+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.5),
         panel.grid.minor.y = element_blank())+
  labs(title = "predicted value of movement level",y="movement level")+
  scale_y_continuous(breaks = seq(-10, 70, by = 10))
```

<!-- A different way of plotting lmer below: -->

<!-- ```{r} -->
<!-- pred_movement_mean_M10 <- ggpredict(mod_movement_mean_M10, terms =c("phase","Allocation")) -->
<!-- ggplot(pred_movement_mean_M10,aes(x=x,y=predicted,colour=group))+ -->
<!--   geom_point(size=2)+ -->
<!--   geom_errorbar(aes(ymin = conf.low, ymax = conf.high),width = 0.2) -->
<!-- ``` -->


```{r}
# Plot Model using another method
df_hlm_lmer_movement_mean$movement_type <- relevel(df_hlm_lmer_movement_mean$movement_type, ref = "M10")
ee1 <- as.data.frame(Effect(c("phase", "Allocation","movement_type"),mod_movement_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_movement_mean_M10)$coefficients,3))[13:16,]
stat.test_L5 <- as.data.frame(round(summary(mod_movement_mean_L5)$coefficients,3))[13:16,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"movement_type"] <- "L5" 
stat.test[5:8,"movement_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee1[ee1$phase != "pre" & ee1$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(movement_type == "L5",ee1$fit[11],if_else(movement_type == "M10", ee1$fit[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4a <- ggplot(ee1, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="movement level")+ 
  scale_y_continuous(limits = c(-10,80),breaks = seq(-10, 80, by = 10))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -4)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a
ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_hlm_movement_val.png",width = 6 ,height=4,dpi = 300)

p4a_M10 <- ggplot(ee1%>%filter(movement_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="daytime movement level", x ="")+ 
  scale_y_continuous(limits = c(40,90),breaks = seq(40, 90, by = 10))+
  stat_pvalue_manual(stat.test%>%filter(movement_type == "M10"), label = "p_sig",vjust = -10)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4a_M10
```


### variability
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + (var_type * movement_type| ID)

df_hlm_lmer_movement_variability <- df_hlm%>%
  select(ID,Allocation,day,phase,movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu,Age,Gender,posLog, negLog, pos_vmu)%>%
  pivot_longer(c(movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu),names_pattern =  "movement_(.*)_(.*)",names_to = c("movement_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_movement_variability$var_type <- factor(df_hlm_lmer_movement_variability$var_type)
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "noise")
df_hlm_lmer_movement_variability$movement_type <- factor(df_hlm_lmer_movement_variability$movement_type)
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

mod_movement_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_s_M10)$coefficients,3))

df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

#same model, different reference level
mod_movement_var_vmu_M10 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_vmu_M10)$coefficients,3))

#same model, different reference level
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "noise")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "L5")

mod_movement_var_s_L5 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_s_L5)$coefficients,3))

df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "L5")

mod_movement_var_vmu_L5 <- lmer(model_formula,data = df_hlm_lmer_movement_variability)
kable(round(summary(mod_movement_var_vmu_L5)$coefficients,3))

plot_model(mod_movement_var_s_M10, type = "pred", terms = c("phase", "Allocation","movement_type","var_type"))
```

*Conclusion: lithium increased volatility of M10 and L5 by week 4.*
*Conclusion: Lithium increases daytime volatility and decreases nighttime volatility of time*



A different way of plotting lmer below:

```{r}
pred_movement_vmu_M10 <- ggpredict(mod_movement_var_vmu_M10, terms =c("phase","Allocation"))
ggplot(pred_movement_vmu_M10,aes(x=x,y=predicted,colour=group))+
  geom_point(size=2)+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),width = 0.2)
```

```{r}
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")
ee2 <- as.data.frame(Effect(c("phase", "Allocation","movement_type","var_type"),mod_movement_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_movement_var_s_M10)$coefficients,3))[16:19,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_movement_var_s_L5)$coefficients,3))[16:19,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_movement_var_vmu_M10)$coefficients,3))[16:19,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_movement_var_vmu_L5)$coefficients,3))[16:19,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"movement_type"] <- "M10" 
stat.test[c(5:8,13:16),"movement_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee2[ee2$phase != "pre" & ee2$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("movement_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility",ee2$fit[1],if_else(var_type == "noise", ee2$fit[21],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p11a <- ggplot(ee2%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement noise")+
  scale_y_continuous(limits = c(-2,-1),breaks = seq(-2,-1, by = 0.2))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -3)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))


#plot volatility first
p11b <- ggplot(ee2%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~movement_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement volatility")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p11a/p11b

ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_hlm_movement_variability.png",width = 7 ,height=7,dpi = 300)

p11b_M10 <- ggplot(ee2%>%filter(var_type == "volatility", movement_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="daytime movement volatility",x="")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", movement_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```

## time
### raw value
```{r}
model_formula_mean <- val ~ Allocation * time_type * phase + posLog + pos_vmu + Age + Gender + (time_type|ID)

df_hlm_lmer_time_mean <- df_hlm%>%
  select(ID,Allocation,phase,day,time_L5_mean,time_M10_mean,Age,Gender,posLog,negLog, pos_vmu)%>%
  pivot_longer(c(time_L5_mean,time_M10_mean),names_pattern =  "time_(.*)_mean",names_to = c("time_type"),values_to = "val")

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")

mod_time_mean_M10 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_M10)$coefficients,3))

df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type)
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "L5")

mod_time_mean_L5 <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
kable(round(summary(mod_time_mean_L5)$coefficients,3))

plot_model(mod_time_mean_M10, type = "pred", terms = c("phase", "Allocation","time_type"))+
  scale_color_manual(values=c("orange","navy"))+
  theme_bw()+
  labs(title = "predicted value of onset time",y="onset time")
```

```{r}
df_hlm_lmer_time_mean$time_type <- relevel(df_hlm_lmer_time_mean$time_type, ref = "M10")
ee3 <- as.data.frame(Effect(c("phase", "Allocation","time_type"),mod_time_mean_M10))

stat.test_M10 <- as.data.frame(round(summary(mod_time_mean_M10)$coefficients,3))[13:16,]
stat.test_L5 <- as.data.frame(round(summary(mod_time_mean_L5)$coefficients,3))[13:16,]
stat.test <- rbind(stat.test_L5,stat.test_M10)%>%rename(p_val = 'Pr(>|t|)')
stat.test[1:4,"time_type"] <- "L5" 
stat.test[5:8,"time_type"] <- "M10" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee3[ee3$phase != "pre" & ee3$Allocation == "control",]%>%
  rename(group1 = phase))%>%
  mutate(y.position = if_else(time_type == "L5",ee3$fit[11],if_else(time_type == "M10", ee3$fit[1],0)))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

p4b <- ggplot(ee3, aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_grid(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="movement onset time (hrs)")+ 
  scale_y_continuous(limits = c(10,30),breaks = seq(10,30, by = 2.5))+
  stat_pvalue_manual(stat.test, label = "p_sig",vjust = -2)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b
ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_hlm_time_val.png",width = 6 ,height=4,dpi = 300)

# p4a/p4b
# ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_vals.png",width = 7 ,height=7,dpi = 300)

p4b_M10 <- ggplot(ee3%>%filter(time_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="daytime movement onset time",x="")+ 
  scale_y_continuous(limits = c(8,16),breaks = seq(8, 16, by = 2))+
  stat_pvalue_manual(stat.test%>%filter(time_type == "M10"), label = "p_sig",vjust = -8)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
p4b_M10
```

### variability 
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * time_type * phase + posLog + pos_vmu + Age + Gender + (var_type * time_type|ID)

df_hlm_lmer_time_variability <- df_hlm%>%
  select(ID,Allocation,day,phase,time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu,Age,Gender,posLog, negLog, pos_vmu)%>%
  pivot_longer(c(time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu),names_pattern =  "time_(.*)_(.*)",names_to = c("time_type","var_type"),values_to = "val")%>%
  mutate(var_type = if_else(var_type == "vmu","volatility","noise"))

df_hlm_lmer_time_variability$var_type <- factor(df_hlm_lmer_time_variability$var_type)
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- factor(df_hlm_lmer_time_variability$time_type)
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

mod_time_var_s_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_M10)$coefficients,3))

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

#same model, different reference level
mod_time_var_vmu_M10 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_vmu_M10)$coefficients,3))

# #same model, different reference level
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "noise")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")

mod_time_var_s_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_s_L5)$coefficients,3))

df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")

df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "L5")
mod_time_var_vmu_L5 <- lmer(model_formula,data = df_hlm_lmer_time_variability)
kable(round(summary(mod_time_var_vmu_L5)$coefficients,3))

plot_model(mod_time_var_s_M10, type = "pred", terms = c("phase", "Allocation","time_type","var_type"))+
  labs(title="predicted value of onset time variability",y="noise")
ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_hlm_time_variability_comparison.png",width = 7 ,height=7,dpi = 300)
```

```{r}
my.df <- df_hlm_lmer_time_variability%>%
  filter(phase %in% c("post4"))%>%
  group_by(phase, ID, Allocation, var_type,time_type)%>%
  summarise(val = mean(val, na.rm = T))

ggplot(my.df%>%filter(var_type == "noise"), aes(x = Allocation, y = val, group = ID, color = Allocation))+
  geom_point(alpha = 0.3)+
  geom_line(alpha = 0.3)+
  facet_wrap(~ time_type)+
  scale_color_manual(values = c("orange","navy"))+
  stat_summary(aes(group = phase),color = "black")+
  labs(y = "noise")

ggplot(my.df%>%filter(var_type == "volatility"), aes(x = Allocation, y = val, group = ID, color = Allocation))+
  geom_point(alpha = 0.3)+
  geom_line(alpha = 0.3)+
  facet_wrap(~ time_type)+
  scale_color_manual(values = c("orange","navy"))+
  stat_summary(aes(group = phase),color = "black")+
  labs(y = "volatility")

#d'
d_ <- df_hlm_lmer_time_variability%>%
  filter(phase %in% c("post4"))%>%
  group_by(Allocation, time_type, var_type)%>%
  summarise(mean = mean(val, na.rm = T),
            sd = sd(val, na.rm = T))%>%
  pivot_wider(names_from = "Allocation", values_from = c("mean","sd"))%>%
  mutate(dPrime = (mean_lithium - mean_control)/sd_lithium)
```

```{r}
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")
ee4 <- as.data.frame(Effect(c("phase", "Allocation","time_type","var_type"),mod_time_var_vmu_M10))

stat.test_s_M10 <- as.data.frame(round(summary(mod_time_var_s_M10)$coefficients,3))[16:19,]
stat.test_s_L5 <- as.data.frame(round(summary(mod_time_var_s_L5)$coefficients,3))[16:19,]
stat.test_vmu_M10 <- as.data.frame(round(summary(mod_time_var_vmu_M10)$coefficients,3))[16:19,]
stat.test_vmu_L5 <- as.data.frame(round(summary(mod_time_var_vmu_L5)$coefficients,3))[16:19,]

stat.test <- Reduce(rbind,list(stat.test_s_M10,stat.test_s_L5,stat.test_vmu_M10,stat.test_vmu_L5))%>%rename(p_val = 'Pr(>|t|)')
stat.test[c(1:4,9:12),"time_type"] <- "M10" 
stat.test[c(5:8,13:16),"time_type"] <- "L5" 

stat.test[1:8,"var_type"] <- "noise" 
stat.test[9:16,"var_type"] <- "volatility" 

stat.test$group1 <- c("post1","post2","post3","post4")
stat.test$group2 <- c("post1","post2","post3","post4")

stat.test <- left_join(stat.test,ee4[ee4$phase != "pre" & ee4$Allocation == "lithium",]%>%
  rename(group1 = phase), by = c("time_type","var_type","group1"))%>%
  mutate(y.position = if_else(var_type == "volatility" & time_type == "L5",ee4$fit[11],if_else(var_type == "volatility" & time_type == "M10", ee4$fit[1],if_else(var_type == "noise" & time_type == "L5",ee4$fit[36],if_else(var_type == "noise" & time_type == "M10",ee4$fit[21],0)))))%>%
  mutate(p_sig = if_else(p_val < 0.001,"***", if_else(p_val < 0.01, "**", if_else(p_val < 0.05, "*", "ns")) ))

#plot noise first
p12a <- ggplot(ee4%>%filter(var_type == "noise"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement noise")+
  scale_y_continuous(limits = c(-2.1,-0.6),breaks = seq(-2.1,-0.6, by = 0.3))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "noise"),label = "p_sig",vjust = -3)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

#plot volatility first
p12b <- ggplot(ee4%>%filter(var_type == "volatility"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  facet_wrap(~time_type)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank())+
  labs(title = "",y="movement volatility")+
  scale_y_continuous(limits = c(-5.6,-3.6),breaks = seq(-5.6,-3.6, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))

p12a/p12b
ggsave("/Users/rh/Desktop/BayesM10/figs/fig2_hlm_time_variability.png",width = 7 ,height=7,dpi = 300)

p12b_M10 <- ggplot(ee4%>%filter(var_type == "volatility", time_type == "M10"), aes(x = phase, y = fit, color = Allocation))+
  scale_color_manual(values=c("orange","navy"))+
  geom_errorbar(aes(ymin = lower,ymax=upper),width=0.1,color = "black")+
    geom_point(size = 3)+
  theme(panel.grid.major.y = element_line(color = "black",size = 0.2),
        panel.grid.minor.y = element_blank(),
         panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45))+
  labs(title = "",y="daytime onset time volatility",x="")+
  scale_y_continuous(limits = c(-5.8,-3.8),breaks = seq(-5.8,-3.8, by = 0.4))+
  stat_pvalue_manual(stat.test%>%filter(var_type == "volatility", time_type == "M10"),label = "p_sig",vjust = 1)+
  scale_x_discrete(labels = c("run-in","week 1","week 2","week 3","week 4"))
```

#manuscript graphs
```{r manuscript figs}
p4a_M10 + p11b_M10+
  plot_annotation(tag_levels = c("A"))
ggsave("/Users/rh/Desktop/BayesM10/figs/man_fig1.png",width = 7 ,height=3,dpi = 300)

p4b_M10 + p12b_M10+
  plot_annotation(tag_levels = c("A"))
ggsave("/Users/rh/Desktop/BayesM10/figs/man_fig2.png",width = 7 ,height=3,dpi = 300)

(p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10) +
  plot_annotation(tag_levels = c("A"))
ggsave("/Users/rh/Desktop/BayesM10/figs/man_fig3.png",width = 7 ,height=6,dpi = 300)
  
(p8_pos + p9_pos) / (p4a_M10 + p11b_M10) / (p4b_M10 + p12b_M10) +
  plot_annotation(tag_levels = c("A"))
ggsave("/Users/rh/Desktop/BayesM10/figs/all_figs.png",width = 7 ,height=10,dpi = 300)
```
#### bayesian model
##### M10
```{r}
df_hlm_lmer_movement_mean$movement_type <- factor(df_hlm_lmer_movement_mean$movement_type, levels = c("M10","L5"))

m_movement_mean_M10  <- brm(val ~ Allocation * movement_type * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_movement_mean,
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_movement_mean_M10"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))
summary(m_movement_mean_M10)
p_map(m_movement_mean_M10)

equivalence_test(m_movement_mean_M10)

plot(equivalence_test(m_movement_mean_M10)[c(4:7,12:15),])
# m_movement_var_vmu_M10 %>%
#   spread_draws(`b_Allocationlithium:phasepost1`, sigma) %>%
#   median_qi()
```

##### M10 predict
```{r}
m_movement_mean_M10_pred  <- brm(val ~ Allocation * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_movement_mean%>%filter(movement_type == "M10"),
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_movement_mean_M10_pred"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))

nd <- data.frame(ID = rep(unique(df_hlm_lmer_movement_mean$ID),5),phase = rep(levels(df_hlm_lmer_movement_mean$phase),each = 34))

nd$posLog <- rep(as.numeric(df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  ungroup()%>%
  summarise(posLog = round(mean(posLog,na.rm = TRUE),2))),nrow(nd))

nd$Age <- rep(as.numeric(df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  ungroup()%>%
  summarise(Age = round(mean(Age,na.rm = TRUE),2)),nrow(nd)))

nd$Gender <- "M"

nd$Allocation[nd$ID %in% df_control$ID] <- "control"
nd$Allocation[nd$ID %in% df_lithium$ID] <- "lithium"

ytilde <- rstantools::posterior_predict(m_movement_mean_M10_pred,nd)
dim(ytilde)
ytilde <- data.frame(val = c(ytilde), phase = rep(rep(levels(df_hlm_lmer_movement_mean$phase),each = 34),2000),ID = rep(unique(df_hlm_lmer_movement_mean$ID),5*2000))
ytilde$Allocation[ytilde$ID %in% df_control$ID] <- "control"
ytilde$Allocation[ytilde$ID %in% df_lithium$ID] <- "lithium"

ytilde$phase <- factor(ytilde$phase, levels = unique(df_hlm$phase))

ggplot(ytilde, aes(x=phase, y=val, color = Allocation)) +
  facet_wrap(~ID)+
  stat_summary(aes(group = phase), geom = "pointrange", size =0.1)+
  labs(title = "M10")

ggsave("/Users/rh/Desktop/BayesM10/figs/ind_figs_M10.png",width = 15 ,height=10,dpi = 300)

ggplot(ytilde%>%
         group_by(ID,phase,Allocation)%>%
         summarise(val = mean(val)), aes(x=phase, y=val, color = Allocation)) +
  geom_jitter(alpha=0.5)+
  stat_summary(aes(group = Allocation), geom = "pointrange")+
  labs(title = "M10")
```

```{r}
df_hlm_lmer_movement_variability$var_type <- relevel(df_hlm_lmer_movement_variability$var_type, ref = "volatility")
df_hlm_lmer_movement_variability$movement_type <- relevel(df_hlm_lmer_movement_variability$movement_type, ref = "M10")

m_movement_var_vmu_M10 <- brm(val ~ Allocation * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_movement_variability,
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_movement_var_vmu_M10"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))
summary(m_movement_var_vmu_M10)
p_map(m_movement_var_vmu_M10)

get_variables(m_movement_var_vmu_M10)
 
sjstats::equivalence_test(m_movement_var_vmu_M10)

plot(equivalence_test(m_movement_var_vmu_M10)[c(15:18),])+
  scale_y_discrete(labels = c("b_Allocationlithium:phasepost1" = "week 1","b_Allocationlithium:phasepost2" = "week 2","b_Allocationlithium:phasepost3" = "week 3","b_Allocationlithium:phasepost4" = "week 4"))+
  labs(title = "daytime activity volatility")

# m_movement_var_vmu_M10 %>%
#   spread_draws(`b_Allocationlithium:phasepost1`, sequivalence_test(m_movement_var_vmu_M10)[igma) %>%
#   median_qi()

```
##### time 10
```{r}
df_hlm_lmer_time_mean$time_type <- factor(df_hlm_lmer_time_mean$time_type, levels = c("M10","L5"))

m_time_mean_M10  <- brm(val ~ Allocation * time_type * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_time_mean,
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_time_mean_M10"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))
summary(m_time_mean_M10)
p_map(m_time_mean_M10)

equivalence_test(m_time_mean_M10)

plot(equivalence_test(m_time_mean_M10)[c(4:7,12:15),])
# m_movement_var_vmu_M10 %>%
#   spread_draws(`b_Allocationlithium:phasepost1`, sigma) %>%
#   median_qi()

```

```{r}
df_hlm_lmer_time_variability$var_type <- relevel(df_hlm_lmer_time_variability$var_type, ref = "volatility")
df_hlm_lmer_time_variability$time_type <- relevel(df_hlm_lmer_time_variability$time_type, ref = "M10")

m_time_var_vmu_M10 <- brm(val ~ Allocation * var_type * time_type * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_time_variability,
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_time_var_vmu_M10"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))
summary(m_time_var_vmu_M10)
p_map(m_time_var_vmu_M10)

get_variables(m_time_var_vmu_M10)

sjstats::equivalence_test(m_time_var_vmu_M10)

plot(equivalence_test(m_time_var_vmu_M10)[c(15:18),])
# m_movement_var_vmu_M10 %>%
#   spread_draws(`b_Allocationlithium:phasepost1`, sequivalence_test(m_movement_var_vmu_M10)[igma) %>%
#   median_qi()

```

##### time M10 predict
predict
```{r}
m_movement_mean_M10_time_pred  <- brm(val ~ Allocation * phase + posLog + pos_vmu + Age + Gender + (1| ID),
                      data = df_hlm_lmer_time_mean%>%filter(time_type == "M10"),
                      seed = 123,
                      save_all_pars = T,
                      file = paste0("/Users/rh/Desktop/BayesM10/data","/m_movement_mean_M10_time_pred"),
                      iter = 1000, warmup = 500, chains = 4, cores = 4,
                      control = list(adapt_delta = 0.99))

nd <- data.frame(ID = rep(unique(df_hlm_lmer_time_mean$ID),5),phase = rep(levels(df_hlm_lmer_time_mean$phase),each = 34))

nd$posLog <- rep(as.numeric(df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  ungroup()%>%
  summarise(posLog = round(mean(posLog,na.rm = TRUE),2))),nrow(nd))

nd$Age <- rep(as.numeric(df_hlm%>%
  filter(day >= -14 & day <= 28)%>%
  ungroup()%>%
  summarise(Age = round(mean(Age,na.rm = TRUE),2)),nrow(nd)))

nd$Gender <- "M"

nd$Allocation[nd$ID %in% df_control$ID] <- "control"
nd$Allocation[nd$ID %in% df_lithium$ID] <- "lithium"

ytilde <- rstantools::posterior_predict(m_movement_mean_M10_time_pred,nd)
dim(ytilde)
ytilde <- data.frame(val = c(ytilde), phase = rep(rep(levels(df_hlm_lmer_time_mean$phase),each = 34),2000),ID = rep(unique(df_hlm_lmer_time_mean$ID),5*2000))
ytilde$Allocation[ytilde$ID %in% df_control$ID] <- "control"
ytilde$Allocation[ytilde$ID %in% df_lithium$ID] <- "lithium"

ytilde$phase <- factor(ytilde$phase, levels = unique(df_hlm$phase))

ggplot(ytilde, aes(x=phase, y=val, color = Allocation)) +
  facet_wrap(~ID)+
  stat_summary(aes(group = phase), geom = "pointrange", size =0.1)+
  labs(title = "M10 time")
ggsave("/Users/rh/Desktop/BayesM10/figs/ind_figs_M10_time.png",width = 15 ,height=10,dpi = 300)

ggplot(ytilde%>%
         group_by(ID,phase,Allocation)%>%
         summarise(val = mean(val)), aes(x=phase, y=val, color = Allocation)) +
  geom_jitter(alpha=0.5)+
  stat_summary(aes(group = Allocation), geom = "pointrange")+
  labs(title = "M10 time")
```
# sensitivity analysis
```{r}
outlierID = c("OL0039","OL0245","OL0209")#"OL0191"
```

```{r}
baseline_values_ <- df_hlm%>%
  filter(day <= 0, !ID %in% outlierID)%>%
  group_by(ID)%>%
  summarise(movement_L5_mean = mean(movement_L5_mean,na.rm = TRUE),
            movement_L5_vmu = mean(movement_L5_vmu,na.rm = TRUE),
            movement_M10_mean = mean(movement_M10_mean,na.rm = TRUE),
            movement_M10_vmu = mean(movement_M10_vmu,na.rm = TRUE),
            time_L5_mean = mean(time_L5_mean,na.rm = TRUE),
            time_L5_vmu = mean(time_L5_vmu,na.rm = TRUE),
            time_M10_mean = mean(time_M10_mean,na.rm = TRUE),
            time_M10_vmu = mean(time_M10_vmu,na.rm = TRUE))

names(baseline_values_)[2:9] <- paste0("baseline_",names(baseline_values_)[2:9])

df_hlm_baseline_ <- left_join(df_hlm, baseline_values_, by = "ID")%>%
  filter(day >= 0 & day <= 28)%>%
  mutate(movement_M10_vmu = movement_M10_vmu - baseline_movement_M10_vmu,
         movement_L5_vmu = movement_L5_vmu - baseline_movement_L5_vmu,
         time_M10_vmu = time_M10_vmu - baseline_time_M10_vmu,
         time_L5_vmu = time_L5_vmu - baseline_time_L5_vmu)

p1<- ggplot(df_hlm_baseline_, aes(x = day, y = movement_M10_vmu, color = Allocation))+
  stat_summary(geom = "pointrange")+
  scale_color_brewer(palette = "Set1")+
  labs(title = "M10 vmu")

p2<- ggplot(df_hlm_baseline_, aes(x = day, y = movement_L5_vmu, color = Allocation))+
  stat_summary(geom = "pointrange")+
  scale_color_brewer(palette = "Set1")+
  labs(title = "L5 vmu")

p3<- ggplot(df_hlm_baseline_, aes(x = day, y = time_M10_vmu, color = Allocation))+
  stat_summary(geom = "pointrange")+
  scale_color_brewer(palette = "Set2")+
  labs(title = "M10 time vmu")

p4<- ggplot(df_hlm_baseline_, aes(x = day, y = time_L5_vmu, color = Allocation))+
  stat_summary(geom = "pointrange")+
  scale_color_brewer(palette = "Set2")+
  labs(title = "L5 time vmu")

(p1+p2)/(p3+p4)
```

## linear mixed model

## movement

### raw value
```{r}
model_formula_mean <- val ~ Allocation * movement_type * phase + posLog + pos_vmu + Age + Gender + (1| ID)

df_hlm_lmer_movement_mean_ <- df_hlm%>%
  filter(!ID %in% outlierID)%>%
  select(ID,Allocation,phase,day,movement_L5_mean,movement_M10_mean,Age,Gender,posLog,pos_vmu)%>%
  pivot_longer(c(movement_L5_mean,movement_M10_mean),names_pattern =  "movement_(.*)_mean",names_to = c("movement_type"),values_to = "val")

df_hlm_lmer_movement_mean_$movement_type <- factor(df_hlm_lmer_movement_mean_$movement_type)
df_hlm_lmer_movement_mean_$movement_type <- relevel(df_hlm_lmer_movement_mean_$movement_type, ref = "M10")

mod_movement_mean_M10_ <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean_)
summary(mod_movement_mean_M10_)

df_hlm_lmer_movement_mean_$movement_type <- factor(df_hlm_lmer_movement_mean_$movement_type)
df_hlm_lmer_movement_mean_$movement_type <- relevel(df_hlm_lmer_movement_mean_$movement_type, ref = "L5")

mod_movement_mean_L5_ <- lmer(model_formula_mean,data = df_hlm_lmer_movement_mean_)
summary(mod_movement_mean_L5_)

plot_model(mod_movement_mean_M10_, type = "pred", terms = c("phase", "Allocation","movement_type"))
```

### variability 
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * movement_type * phase + posLog + pos_vmu + Age + Gender + (1| ID)

df_hlm_lmer_movement_variability_ <- df_hlm%>%
  filter(! ID %in% outlierID)%>%
  select(ID,Allocation,day,phase,movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu,Age,Gender,posLog,pos_vmu)%>%
  pivot_longer(c(movement_L5_s,movement_L5_vmu, movement_M10_s,movement_M10_vmu),names_pattern =  "movement_(.*)_(.*)",names_to = c("movement_type","var_type"),values_to = "val")

df_hlm_lmer_movement_variability_$var_type <- factor(df_hlm_lmer_movement_variability_$var_type)
df_hlm_lmer_movement_variability_$var_type <- relevel(df_hlm_lmer_movement_variability_$var_type, ref = "s")
df_hlm_lmer_movement_variability_$movement_type <- factor(df_hlm_lmer_movement_variability_$movement_type)
df_hlm_lmer_movement_variability_$movement_type <- relevel(df_hlm_lmer_movement_variability_$movement_type, ref = "M10")

mod_movement_var_s_M10_ <- lmer(model_formula,data = df_hlm_lmer_movement_variability_)
summary(mod_movement_var_s_M10_)

df_hlm_lmer_movement_variability_$var_type <- relevel(df_hlm_lmer_movement_variability_$var_type, ref = "vmu")
df_hlm_lmer_movement_variability_$movement_type <- relevel(df_hlm_lmer_movement_variability_$movement_type, ref = "M10")

#same model, different reference level
mod_movement_var_vmu_M10_ <- lmer(model_formula,data = df_hlm_lmer_movement_variability_)
summary(mod_movement_var_vmu_M10_)

#same model, different reference level
df_hlm_lmer_movement_variability_$var_type <- relevel(df_hlm_lmer_movement_variability_$var_type, ref = "s")
df_hlm_lmer_movement_variability_$movement_type <- relevel(df_hlm_lmer_movement_variability_$movement_type, ref = "L5")

mod_movement_var_s_L5_ <- lmer(model_formula,data = df_hlm_lmer_movement_variability_)
summary(mod_movement_var_s_L5_)

df_hlm_lmer_movement_variability_$var_type <- relevel(df_hlm_lmer_movement_variability_$var_type, ref = "vmu")
df_hlm_lmer_movement_variability_$movement_type <- relevel(df_hlm_lmer_movement_variability_$movement_type, ref = "L5")

mod_movement_var_vmu_L5_ <- lmer(model_formula,data = df_hlm_lmer_movement_variability_)
summary(mod_movement_var_vmu_L5_)

plot_model(mod_movement_var_s_M10_, type = "pred", terms = c("phase", "Allocation","movement_type","var_type"))
```

Results on movement variability were the same.


## time
### raw value
```{r}
model_formula_mean <- val ~ Allocation * time_type * phase + posLog + pos_vmu + Age + Gender + (1| ID)

df_hlm_lmer_time_mean_ <- df_hlm%>%
  filter(! ID %in% outlierID)%>%
  select(ID,Allocation,phase,day,time_L5_mean,time_M10_mean,Age,Gender,posLog, pos_vmu)%>%
  pivot_longer(c(time_L5_mean,time_M10_mean),names_pattern =  "time_(.*)_mean",names_to = c("time_type"),values_to = "val")

df_hlm_lmer_time_mean_$time_type <- factor(df_hlm_lmer_time_mean_$time_type)
df_hlm_lmer_time_mean_$time_type <- relevel(df_hlm_lmer_time_mean_$time_type, ref = "M10")

mod_time_mean_M10_ <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean_)
summary(mod_time_mean_M10_)

df_hlm_lmer_time_mean_$time_type <- factor(df_hlm_lmer_time_mean_$time_type)
df_hlm_lmer_time_mean_$time_type <- relevel(df_hlm_lmer_time_mean_$time_type, ref = "L5")

mod_time_mean_L5_ <- lmer(model_formula_mean,data = df_hlm_lmer_time_mean)
summary(mod_time_mean_L5_)

plot_model(mod_time_mean_M10_, type = "pred", terms = c("phase", "Allocation","time_type"))
```
### variability 
```{r include=TRUE}
model_formula <- val ~ Allocation * var_type * time_type * phase + posLog + pos_vmu + Age + Gender + (1| ID)

df_hlm_lmer_time_variability_ <- df_hlm%>%
  filter(!ID %in% outlierID)%>%
  select(ID,Allocation,day,phase,time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu,Age,Gender,posLog,pos_vmu)%>%
  pivot_longer(c(time_L5_s,time_L5_vmu, time_M10_s,time_M10_vmu),names_pattern =  "time_(.*)_(.*)",names_to = c("time_type","var_type"),values_to = "val")

df_hlm_lmer_time_variability_$var_type <- factor(df_hlm_lmer_time_variability_$var_type)
df_hlm_lmer_time_variability_$var_type <- relevel(df_hlm_lmer_time_variability_$var_type, ref = "s")
df_hlm_lmer_time_variability_$time_type <- factor(df_hlm_lmer_time_variability_$time_type)
df_hlm_lmer_time_variability_$time_type <- relevel(df_hlm_lmer_time_variability_$time_type, ref = "M10")

mod_time_var_s_M10_ <- lmer(model_formula,data = df_hlm_lmer_time_variability_)
summary(mod_time_var_s_M10_)

df_hlm_lmer_time_variability_$var_type <- relevel(df_hlm_lmer_time_variability_$var_type, ref = "vmu")
df_hlm_lmer_time_variability_$time_type <- relevel(df_hlm_lmer_time_variability_$time_type, ref = "M10")

#same model, different reference level
mod_time_var_vmu_M10_ <- lmer(model_formula,data = df_hlm_lmer_time_variability_)
summary(mod_time_var_vmu_M10_)

#same model, different reference level
df_hlm_lmer_time_variability_$var_type <- relevel(df_hlm_lmer_time_variability_$var_type, ref = "s")
df_hlm_lmer_time_variability_$time_type <- relevel(df_hlm_lmer_time_variability_$time_type, ref = "L5")

mod_time_var_s_L5_ <- lmer(model_formula,data = df_hlm_lmer_time_variability_)
summary(mod_time_var_s_L5_)

df_hlm_lmer_time_variability_$var_type <- relevel(df_hlm_lmer_time_variability_$var_type, ref = "vmu")
df_hlm_lmer_time_variability_$time_type <- relevel(df_hlm_lmer_time_variability_$time_type, ref = "L5")

mod_time_var_vmu_L5_ <- lmer(model_formula,data = df_hlm_lmer_time_variability_)
summary(mod_time_var_vmu_L5_)

plot_model(mod_time_var_s_M10_, type = "pred", terms = c("phase", "Allocation","time_type","var_type"))
```


Results on time variability were the same.

# mediation analysis
```{r warning=F}
df_med <- df_hlm%>%
  select(ID, day,phase, Age, Gender, Allocation,movement_M10_vmu,movement_M10_mean,pos_mean,pos_vmu)%>%
  filter(!is.na(movement_M10_vmu), !is.na(pos_vmu))%>%
  mutate(time = ifelse(phase == "pre",0,
                       ifelse(phase == "post1",1,
                              ifelse(phase == "post2",2,
                                     ifelse(phase == "post3",3,
                                            ifelse(phase == "post4",4, NA))))))

fit.mediator <- lme4::lmer(movement_M10_vmu ~ Allocation * time + Age + Gender +(1| ID), data = df_med)
summary(fit.mediator)
fit.dv <- lme4::lmer(pos_vmu ~ movement_M10_vmu * Allocation + Allocation * time + Age + Gender +(1 + movement_M10_vmu| ID), data = df_med)
summary(fit.dv)

results <- mediation::mediate(fit.mediator, fit.dv, treat='Allocation', mediator = 'movement_M10_vmu',sims = 10000)
summary(results)
plot(results)

resultsPost3 <- mediation::mediate(fit.mediator, fit.dv, treat='Allocation', mediator='movement_M10_vmu',covariates = list(time = 3),sims = 10000)
summary(resultsPost3)
plot(resultsPost3)

resultsPost4 <- mediation::mediate(fit.mediator, fit.dv, treat='Allocation', mediator='movement_M10_vmu',covariates = list(time = 4),sims = 10000)
summary(resultsPost4)
plot(resultsPost4)
```

## Exploratory analysis: Moderated 1-1-1 mediation model

```{r}
df_mediation2 <- df_med%>%
  filter(!is.na(pos_vmu),!is.na(movement_M10_vmu))%>%
  select(ID, time, day, Age, Gender, Allocation, movement_M10_vmu,pos_vmu)%>%
  mutate(x = time,
         m = movement_M10_vmu,
         y = pos_vmu)%>%
  mutate(treat = ifelse(Allocation == "control",-0.5,
                        ifelse(Allocation == "lithium", 0.5,
                               NA)))

ggplot(data = df_mediation2[which(df_mediation2$ID <= "OL0025"), ], 
       aes(x = x, y = y, group = ID)) +
  geom_point(color = "black", alpha = .7) + 
  labs(title = "x->y",
       x = "phase",
       y = "Movement volatility (within)")+
  facet_wrap(~ID)

ggplot(data = df_mediation2[which(df_mediation2$ID <= "OL0025"), ], 
       aes(x = x, y = m, group = ID)) +
  geom_point(color = "blue",  alpha = .7) + 
  labs(title = "x->m",
       x = "phase",
       y = "PA volatility (within)")+
  facet_wrap( ~ ID)

ggplot(data = df_mediation2[which(df_mediation2$ID <= "OL0025"), ], 
       aes(x = m, y = y, group = ID)) +
  geom_point(aes(color = "red"),  alpha = .7) + 
  geom_smooth(method = "lm")+
  labs(title = "m->y",
       x = "Movement volatility",
       y = "PA volatility (within)")+
  facet_wrap( ~ ID)
```



```{r}
summary(m1 <- lme4::lmer(y ~ x + (1 + x | ID), data = df_mediation2))
summary(m2 <- lme4::lmer(m ~ x + (1 + x | ID), data = df_mediation2))
summary(m3 <- lme4::lmer(y ~ m + x + (1 + m + x | ID), data = df_mediation2))
#We see that the IV although still significant has been reduced.

df_mediation2$fid <- 1:nrow(df_mediation2)

stacked <- reshape2::melt(df_mediation2, id.vars = c("fid", "ID", "x", "m"),
   measure.vars = c("y", "m"), value.name = "z")

stacked <- within(stacked, {
  sy <- as.integer(variable == "y")
  sm <- as.integer(variable == "m")
})
```

Add in moderation of treatment (between-subject variable)
```{r}
stacked_mod <- left_join(stacked,df_mediation2[,c("ID","treat")],
                         by = "ID")

## fit model
mmm <- lmer(z ~ 0 + 
                    #  add in treat as main effect and moderator
                    sm +  sm:x +
                    sm:treat + sm:x:treat +
                    sy + sy:m + sy:x +
                    sy:treat + sy:m:treat + sy:x:treat +
               (0 + sm + sm:x + sy + sy:m + sy:x | ID) +
               (0 + sm | fid), data = stacked_mod)

(smmm <- summary(mmm))

#Because treat is effect coded, the values we obtain for main effects are estimates averaging over treatment condition.
FE_mod <- lme4::fixef(mmm)

cbind(t(t(FE_mod)%>%
  as.data.frame()%>%
  rename(movement_vmu = sm,
         PA_vmu = sy,
         `time --> movement_vmu` = `sm:x`,
         `lithium --> movement_vmu` =  `sm:treat`,
         `movement_vmu --> PA_vmu` = `sy:m`,
         `time --> PA_vmu` = `x:sy`,
         `lithium --> PA_vmu` = `treat:sy`,
         `lithium * time --> movement_vmu` = `sm:x:treat`,
         `lithium * movement_vmu --> PA_vmu`=`treat:sy:m`,
         `lithium * time --> PA_vmu`=`x:treat:sy`)),
  p = smmm$coefficients[,5])%>%
  kable()
```

```{r}
## mediation paths
a_mod <- as.numeric(lme4::fixef(mmm)["sm:x"])

b_mod <- as.numeric(lme4::fixef(mmm)["sy:m"])

cprime_mod <- as.numeric(lme4::fixef(mmm)["x:sy"]) #direct effect

# moderation of mediation paths
aXtreat_mod <- as.numeric(lme4::fixef(mmm)["sm:x:treat"])

bXtreat_mod <- as.numeric(lme4::fixef(mmm)["treat:sy:m"])

cprimeXtreat_mod <- as.numeric(lme4::fixef(mmm)["x:treat:sy"])

## product of 'a' and 'b' paths
ab <- prod(fixef(mmm)[c("sm:x", "sy:m")])

## covariance between random effects
rcov <- VarCorr(mmm)[["ID"]]["sm:x", "sy:m"]

## indirect effect
indirect_eff <- (ab + rcov)

## total effect
total_eff <- indirect_eff + cprime_mod

treat_weight <- 0.5 #reflects effect coding of treat = -.5

indirecteffect_treat_mod <- (a_mod + treat_weight*aXtreat_mod)*
                            (b_mod + treat_weight*bXtreat_mod) + rcov # + covajbj_mod   

total_eff_treat_mod <-  cprime_mod + treat_weight * cprimeXtreat_mod + indirecteffect_treat_mod

control_weight <- -.5 #reflects effect coding of treat = -.5

indirecteffect_control_mod <- (a_mod + control_weight*aXtreat_mod)*
                              (b_mod + control_weight*bXtreat_mod) # + covajbj_mod

(percentmediated <- 100*(indirect_eff/total_eff))
```

```{r}
# pull out person-specific coefficients
ind_ranefs <- data.frame(coef(mmm)$ID)
ind_ranefs$ID <- row.names(ind_ranefs)

# combine with info about treatment condition
ind_ranefs_treat <- merge(ind_ranefs, unique(df_mediation2%>%
                            select(ID, treat)), by = "ID")

# compute person specific indirect effect
ind_ranefs_treat$indirect <-
  # moderated a path
  (ind_ranefs_treat$sm.x + ind_ranefs_treat$treat * ind_ranefs_treat$sm.x.treat) *
  # moderated b path
  (ind_ranefs_treat$x.sy + ind_ranefs_treat$treat * ind_ranefs_treat$treat.sy.m) 
```


```{r fig.cap="Indirect effect by treatment"}
# create an empty y-variable strictly for plotting purposes
ind_ranefs_treat$y <- NA

ggplot(ind_ranefs_treat, aes(x = indirect, y = y, color = as.factor(treat))) +
  # add in data points showing subject-specific mediation effect, colored by treat
  geom_point(position = position_jitter(h = .03), alpha = .4, size = 2) +
  scale_color_manual(values = c("red", "blue"), labels = c("Control", "Treatment")) +
  xlab("Indirect Effect") +
  geom_point(aes(x = indirecteffect_control_mod, y = y), color = "red", size = 6) + 
  geom_point(aes(x = indirecteffect_treat_mod, y = y), color = "navyblue", size = 6) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(color = "Condition") +
  theme(legend.position="bottom")
```

```{r fig.cap="Moderated mediation model, level = average"}
mod_med_model = data.frame(
  lab_x = 'Time',
  lab_m = 'M10\\nVolatility',
  lab_y = 'Positive affect\\nVolatility',
  coef_xm = round(a_mod,2),
  coef_my = round(b_mod,2),
  coef_xy = paste0(round(total_eff,2)," (",round(cprime_mod,2),")")
)

med_diagram(mod_med_model)
```

```{r fig.cap="Moderated mediation model, level = lithium"}
mod_med_model_lith = data.frame(
  lab_x = 'Time',
  lab_m = 'M10\\nVolatility',
  lab_y = 'Positive affect\\nVolatility',
  coef_xm = round(a_mod + treat_weight*aXtreat_mod,2),
  coef_my = round(b_mod + treat_weight*bXtreat_mod,2),
  coef_xy = paste0(round(total_eff_treat_mod,2)," (",round(cprime_mod + treat_weight * cprimeXtreat_mod,2), ")")
)

med_diagram(mod_med_model_lith, color = "navy")
```


